var Qi=Object.create;var ye=Object.defineProperty;var er=Object.getOwnPropertyDescriptor;var tr=Object.getOwnPropertyNames;var sr=Object.getPrototypeOf,nr=Object.prototype.hasOwnProperty;var o=(e,t)=>ye(e,"name",{value:t,configurable:!0}),We=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,s)=>(typeof require<"u"?require:t)[s]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+e+'" is not supported')});var U=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ir=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of tr(t))!nr.call(e,i)&&i!==s&&ye(e,i,{get:()=>t[i],enumerable:!(n=er(t,i))||n.enumerable});return e};var xe=(e,t,s)=>(s=e!=null?Qi(sr(e)):{},ir(t||!e||!e.__esModule?ye(s,"default",{value:e,enumerable:!0}):s,e));var nt=U(()=>{});var Ie=U((ne,it)=>{(function(e,t){typeof ne=="object"?it.exports=ne=t():typeof define=="function"&&define.amd?define([],t):e.CryptoJS=t()})(ne,function(){var e=e||function(t,s){var n;if(typeof window<"u"&&window.crypto&&(n=window.crypto),typeof self<"u"&&self.crypto&&(n=self.crypto),typeof globalThis<"u"&&globalThis.crypto&&(n=globalThis.crypto),!n&&typeof window<"u"&&window.msCrypto&&(n=window.msCrypto),!n&&typeof global<"u"&&global.crypto&&(n=global.crypto),!n&&typeof We=="function")try{n=nt()}catch{}var i=o(function(){if(n){if(typeof n.getRandomValues=="function")try{return n.getRandomValues(new Uint32Array(1))[0]}catch{}if(typeof n.randomBytes=="function")try{return n.randomBytes(4).readInt32LE()}catch{}}throw new Error("Native crypto module could not be used to get secure random number.")},"cryptoSecureRandomInt"),r=Object.create||function(){function m(){}return o(m,"F"),function(p){var w;return m.prototype=p,w=new m,m.prototype=null,w}}(),a={},c=a.lib={},l=c.Base=function(){return{extend:function(m){var p=r(this);return m&&p.mixIn(m),(!p.hasOwnProperty("init")||this.init===p.init)&&(p.init=function(){p.$super.init.apply(this,arguments)}),p.init.prototype=p,p.$super=this,p},create:function(){var m=this.extend();return m.init.apply(m,arguments),m},init:function(){},mixIn:function(m){for(var p in m)m.hasOwnProperty(p)&&(this[p]=m[p]);m.hasOwnProperty("toString")&&(this.toString=m.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),u=c.WordArray=l.extend({init:function(m,p){m=this.words=m||[],p!=s?this.sigBytes=p:this.sigBytes=m.length*4},toString:function(m){return(m||f).stringify(this)},concat:function(m){var p=this.words,w=m.words,v=this.sigBytes,E=m.sigBytes;if(this.clamp(),v%4)for(var S=0;S<E;S++){var _=w[S>>>2]>>>24-S%4*8&255;p[v+S>>>2]|=_<<24-(v+S)%4*8}else for(var A=0;A<E;A+=4)p[v+A>>>2]=w[A>>>2];return this.sigBytes+=E,this},clamp:function(){var m=this.words,p=this.sigBytes;m[p>>>2]&=4294967295<<32-p%4*8,m.length=t.ceil(p/4)},clone:function(){var m=l.clone.call(this);return m.words=this.words.slice(0),m},random:function(m){for(var p=[],w=0;w<m;w+=4)p.push(i());return new u.init(p,m)}}),d=a.enc={},f=d.Hex={stringify:function(m){for(var p=m.words,w=m.sigBytes,v=[],E=0;E<w;E++){var S=p[E>>>2]>>>24-E%4*8&255;v.push((S>>>4).toString(16)),v.push((S&15).toString(16))}return v.join("")},parse:function(m){for(var p=m.length,w=[],v=0;v<p;v+=2)w[v>>>3]|=parseInt(m.substr(v,2),16)<<24-v%8*4;return new u.init(w,p/2)}},y=d.Latin1={stringify:function(m){for(var p=m.words,w=m.sigBytes,v=[],E=0;E<w;E++){var S=p[E>>>2]>>>24-E%4*8&255;v.push(String.fromCharCode(S))}return v.join("")},parse:function(m){for(var p=m.length,w=[],v=0;v<p;v++)w[v>>>2]|=(m.charCodeAt(v)&255)<<24-v%4*8;return new u.init(w,p)}},x=d.Utf8={stringify:function(m){try{return decodeURIComponent(escape(y.stringify(m)))}catch{throw new Error("Malformed UTF-8 data")}},parse:function(m){return y.parse(unescape(encodeURIComponent(m)))}},g=c.BufferedBlockAlgorithm=l.extend({reset:function(){this._data=new u.init,this._nDataBytes=0},_append:function(m){typeof m=="string"&&(m=x.parse(m)),this._data.concat(m),this._nDataBytes+=m.sigBytes},_process:function(m){var p,w=this._data,v=w.words,E=w.sigBytes,S=this.blockSize,_=S*4,A=E/_;m?A=t.ceil(A):A=t.max((A|0)-this._minBufferSize,0);var k=A*S,C=t.min(k*4,E);if(k){for(var I=0;I<k;I+=S)this._doProcessBlock(v,I);p=v.splice(0,k),w.sigBytes-=C}return new u.init(p,C)},clone:function(){var m=l.clone.call(this);return m._data=this._data.clone(),m},_minBufferSize:0}),R=c.Hasher=g.extend({cfg:l.extend(),init:function(m){this.cfg=this.cfg.extend(m),this.reset()},reset:function(){g.reset.call(this),this._doReset()},update:function(m){return this._append(m),this._process(),this},finalize:function(m){m&&this._append(m);var p=this._doFinalize();return p},blockSize:512/32,_createHelper:function(m){return function(p,w){return new m.init(w).finalize(p)}},_createHmacHelper:function(m){return function(p,w){return new b.HMAC.init(m,w).finalize(p)}}}),b=a.algo={};return a}(Math);return e})});var ot=U((ie,rt)=>{(function(e,t){typeof ie=="object"?rt.exports=ie=t(Ie()):typeof define=="function"&&define.amd?define(["./core"],t):t(e.CryptoJS)})(ie,function(e){return e.enc.Hex})});var ct=U((re,at)=>{(function(e,t){typeof re=="object"?at.exports=re=t(Ie()):typeof define=="function"&&define.amd?define(["./core"],t):t(e.CryptoJS)})(re,function(e){return function(){var t=e,s=t.lib,n=s.WordArray,i=s.Hasher,r=t.algo,a=[],c=r.SHA1=i.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(l,u){for(var d=this._hash.words,f=d[0],y=d[1],x=d[2],g=d[3],R=d[4],b=0;b<80;b++){if(b<16)a[b]=l[u+b]|0;else{var m=a[b-3]^a[b-8]^a[b-14]^a[b-16];a[b]=m<<1|m>>>31}var p=(f<<5|f>>>27)+R+a[b];b<20?p+=(y&x|~y&g)+1518500249:b<40?p+=(y^x^g)+1859775393:b<60?p+=(y&x|y&g|x&g)-1894007588:p+=(y^x^g)-899497514,R=g,g=x,x=y<<30|y>>>2,y=f,f=p}d[0]=d[0]+f|0,d[1]=d[1]+y|0,d[2]=d[2]+x|0,d[3]=d[3]+g|0,d[4]=d[4]+R|0},_doFinalize:function(){var l=this._data,u=l.words,d=this._nDataBytes*8,f=l.sigBytes*8;return u[f>>>5]|=128<<24-f%32,u[(f+64>>>9<<4)+14]=Math.floor(d/4294967296),u[(f+64>>>9<<4)+15]=d,l.sigBytes=u.length*4,this._process(),this._hash},clone:function(){var l=i.clone.call(this);return l._hash=this._hash.clone(),l}});t.SHA1=i._createHelper(c),t.HmacSHA1=i._createHmacHelper(c)}(),e.SHA1})});var Li=U((Au,Di)=>{"use strict";var Ne=Object.defineProperty,Lr=Object.getOwnPropertyDescriptor,Nr=Object.getOwnPropertyNames,Br=Object.prototype.hasOwnProperty,Mr=o((e,t)=>{for(var s in t)Ne(e,s,{get:t[s],enumerable:!0})},"w"),Ur=o((e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Nr(t))!Br.call(e,i)&&i!==s&&Ne(e,i,{get:()=>t[i],enumerable:!(n=Lr(t,i))||n.enumerable});return e},"A"),jr=o(e=>Ur(Ne({},"__esModule",{value:!0}),e),"x"),_i={};Mr(_i,{Analytics:()=>Wr});Di.exports=jr(_i);var Ii=`
local key = KEYS[1]
local field = ARGV[1]

local data = redis.call("ZRANGE", key, 0, -1, "WITHSCORES")
local count = {}

for i = 1, #data, 2 do
  local json_str = data[i]
  local score = tonumber(data[i + 1])
  local obj = cjson.decode(json_str)

  local fieldValue = obj[field]

  if count[fieldValue] == nil then
    count[fieldValue] = score
  else
    count[fieldValue] = count[fieldValue] + score
  end
end

local result = {}
for k, v in pairs(count) do
  table.insert(result, {k, v})
end

return result
`,Hr=`
local prefix = KEYS[1]
local first_timestamp = tonumber(ARGV[1]) -- First timestamp to check
local increment = tonumber(ARGV[2])       -- Increment between each timestamp
local num_timestamps = tonumber(ARGV[3])  -- Number of timestampts to check (24 for a day and 24 * 7 for a week)
local num_elements = tonumber(ARGV[4])    -- Number of elements to fetch in each category
local check_at_most = tonumber(ARGV[5])   -- Number of elements to check at most.

local keys = {}
for i = 1, num_timestamps do
  local timestamp = first_timestamp - (i - 1) * increment
  table.insert(keys, prefix .. ":" .. timestamp)
end

-- get the union of the groups
local zunion_params = {"ZUNION", num_timestamps, unpack(keys)}
table.insert(zunion_params, "WITHSCORES")
local result = redis.call(unpack(zunion_params))

-- select num_elements many items
local true_group = {}
local false_group = {}
local denied_group = {}
local true_count = 0
local false_count = 0
local denied_count = 0
local i = #result - 1

-- index to stop at after going through "checkAtMost" many items:
local cutoff_index = #result - 2 * check_at_most

-- iterate over the results
while (true_count + false_count + denied_count) < (num_elements * 3) and 1 <= i and i >= cutoff_index do
  local score = tonumber(result[i + 1])
  if score > 0 then
    local element = result[i]
    if string.find(element, "success\\":true") and true_count < num_elements then
      table.insert(true_group, {score, element})
      true_count = true_count + 1
    elseif string.find(element, "success\\":false") and false_count < num_elements then
      table.insert(false_group, {score, element})
      false_count = false_count + 1
    elseif string.find(element, "success\\":\\"denied") and denied_count < num_elements then
      table.insert(denied_group, {score, element})
      denied_count = denied_count + 1
    end
  end
  i = i - 2
end

return {true_group, false_group, denied_group}
`,zr=`
local prefix = KEYS[1]
local first_timestamp = tonumber(ARGV[1])
local increment = tonumber(ARGV[2])
local num_timestamps = tonumber(ARGV[3])

local keys = {}
for i = 1, num_timestamps do
  local timestamp = first_timestamp - (i - 1) * increment
  table.insert(keys, prefix .. ":" .. timestamp)
end

-- get the union of the groups
local zunion_params = {"ZUNION", num_timestamps, unpack(keys)}
table.insert(zunion_params, "WITHSCORES")
local result = redis.call(unpack(zunion_params))

return result
`,Wr=o(class{redis;prefix;bucketSize;constructor(e){this.redis=e.redis,this.prefix=e.prefix??"@upstash/analytics",this.bucketSize=this.parseWindow(e.window)}validateTableName(e){if(!/^[a-zA-Z0-9_-]+$/.test(e))throw new Error(`Invalid table name: ${e}. Table names can only contain letters, numbers, dashes and underscores.`)}parseWindow(e){if(typeof e=="number"){if(e<=0)throw new Error(`Invalid window: ${e}`);return e}let t=/^(\d+)([smhd])$/;if(!t.test(e))throw new Error(`Invalid window: ${e}`);let[,s,n]=e.match(t),i=parseInt(s);switch(n){case"s":return i*1e3;case"m":return i*1e3*60;case"h":return i*1e3*60*60;case"d":return i*1e3*60*60*24;default:throw new Error(`Invalid window unit: ${n}`)}}getBucket(e){let t=e??Date.now();return Math.floor(t/this.bucketSize)*this.bucketSize}async ingest(e,...t){this.validateTableName(e),await Promise.all(t.map(async s=>{let n=this.getBucket(s.time),i=[this.prefix,e,n].join(":");await this.redis.zincrby(i,1,JSON.stringify({...s,time:void 0}))}))}formatBucketAggregate(e,t,s){let n={};return e.forEach(([i,r])=>{t=="success"&&(i=i===1?"true":i===null?"false":i),n[t]=n[t]||{},n[t][(i??"null").toString()]=r}),{time:s,...n}}async aggregateBucket(e,t,s){this.validateTableName(e);let n=this.getBucket(s),i=[this.prefix,e,n].join(":"),r=await this.redis.eval(Ii,[i],[t]);return this.formatBucketAggregate(r,t,n)}async aggregateBuckets(e,t,s,n){this.validateTableName(e);let i=this.getBucket(n),r=[];for(let a=0;a<s;a+=1)r.push(this.aggregateBucket(e,t,i)),i=i-this.bucketSize;return Promise.all(r)}async aggregateBucketsWithPipeline(e,t,s,n,i){this.validateTableName(e),i=i??48;let r=this.getBucket(n),a=[],c=this.redis.pipeline(),l=[];for(let u=1;u<=s;u+=1){let d=[this.prefix,e,r].join(":");c.eval(Ii,[d],[t]),a.push(r),r=r-this.bucketSize,(u%i==0||u==s)&&(l.push(c.exec()),c=this.redis.pipeline())}return(await Promise.all(l)).flat().map((u,d)=>this.formatBucketAggregate(u,t,a[d]))}async getAllowedBlocked(e,t,s){this.validateTableName(e);let n=[this.prefix,e].join(":"),i=this.getBucket(s),r=await this.redis.eval(zr,[n],[i,this.bucketSize,t]),a={};for(let c=0;c<r.length;c+=2){let l=r[c],u=l.identifier,d=+r[c+1];a[u]||(a[u]={success:0,blocked:0}),a[u][l.success?"success":"blocked"]=d}return a}async getMostAllowedBlocked(e,t,s,n,i){this.validateTableName(e);let r=[this.prefix,e].join(":"),a=this.getBucket(n),c=i??s*5,[l,u,d]=await this.redis.eval(Hr,[r],[a,this.bucketSize,t,s,c]);return{allowed:this.toDicts(l),ratelimited:this.toDicts(u),denied:this.toDicts(d)}}toDicts(e){let t=[];for(let s=0;s<e.length;s+=1){let n=+e[s][0],i=e[s][1];t.push({identifier:i.identifier,count:n})}return t}},"b")});var Vi=U((_u,Fi)=>{"use strict";var Be=Object.defineProperty,Kr=Object.getOwnPropertyDescriptor,Gr=Object.getOwnPropertyNames,qr=Object.prototype.hasOwnProperty,Mi=o((e,t)=>{for(var s in t)Be(e,s,{get:t[s],enumerable:!0})},"__export"),$r=o((e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Gr(t))!qr.call(e,i)&&i!==s&&Be(e,i,{get:()=>t[i],enumerable:!(n=Kr(t,i))||n.enumerable});return e},"__copyProps"),Fr=o(e=>$r(Be({},"__esModule",{value:!0}),e),"__toCommonJS"),Ui={};Mi(Ui,{Analytics:()=>ji,IpDenyList:()=>Wi,MultiRegionRatelimit:()=>vo,Ratelimit:()=>bo});Fi.exports=Fr(Ui);var Vr=Li(),ji=o(class{analytics;table="events";constructor(e){this.analytics=new Vr.Analytics({redis:e.redis,window:"1h",prefix:e.prefix??"@upstash/ratelimit",retention:"90d"})}extractGeo(e){return e.geo!==void 0?e.geo:e.cf!==void 0?e.cf:{}}async record(e){await this.analytics.ingest(this.table,e)}async series(e,t){let s=Math.min((this.analytics.getBucket(Date.now())-this.analytics.getBucket(t))/36e5,256);return this.analytics.aggregateBucketsWithPipeline(this.table,e,s)}async getUsage(e=0){let t=Math.min((this.analytics.getBucket(Date.now())-this.analytics.getBucket(e))/36e5,256);return await this.analytics.getAllowedBlocked(this.table,t)}async getUsageOverTime(e,t){return await this.analytics.aggregateBucketsWithPipeline(this.table,t,e)}async getMostAllowedBlocked(e,t,s){t=t??5;let n=void 0;return this.analytics.getMostAllowedBlocked(this.table,e,t,n,s)}},"Analytics"),me=o(class{cache;constructor(e){this.cache=e}isBlocked(e){if(!this.cache.has(e))return{blocked:!1,reset:0};let t=this.cache.get(e);return t<Date.now()?(this.cache.delete(e),{blocked:!1,reset:0}):{blocked:!0,reset:t}}blockUntil(e,t){this.cache.set(e,t)}set(e,t){this.cache.set(e,t)}get(e){return this.cache.get(e)||null}incr(e){let t=this.cache.get(e)??0;return t+=1,this.cache.set(e,t),t}pop(e){this.cache.delete(e)}empty(){this.cache.clear()}size(){return this.cache.size}},"Cache");function M(e){let t=e.match(/^(\d+)\s?(ms|s|m|h|d)$/);if(!t)throw new Error(`Unable to parse window size: ${e}`);let s=Number.parseInt(t[1]);switch(t[2]){case"ms":return s;case"s":return s*1e3;case"m":return s*1e3*60;case"h":return s*1e3*60*60;case"d":return s*1e3*60*60*24;default:throw new Error(`Unable to parse window size: ${e}`)}}o(M,"ms");var T=o(async(e,t,s,n)=>{try{return await e.redis.evalsha(t.hash,s,n)}catch(i){if(`${i}`.includes("NOSCRIPT")){let r=await e.redis.scriptLoad(t.script);return r!==t.hash&&console.warn("Upstash Ratelimit: Expected hash and the hash received from Redis are different. Ratelimit will work as usual but performance will be reduced."),await e.redis.evalsha(r,s,n)}throw i}},"safeEval"),Jr=`
  local key           = KEYS[1]
  local window        = ARGV[1]
  local incrementBy   = ARGV[2] -- increment rate per request at a given value, default is 1

  local r = redis.call("INCRBY", key, incrementBy)
  if r == tonumber(incrementBy) then
  -- The first time this key is set, the value will be equal to incrementBy.
  -- So we only need the expire command once
  redis.call("PEXPIRE", key, window)
  end

  return r
`,Xr=`
      local key = KEYS[1]
      local tokens = 0

      local value = redis.call('GET', key)
      if value then
          tokens = value
      end
      return tokens
    `,Yr=`
  local currentKey  = KEYS[1]           -- identifier including prefixes
  local previousKey = KEYS[2]           -- key of the previous bucket
  local tokens      = tonumber(ARGV[1]) -- tokens per window
  local now         = ARGV[2]           -- current timestamp in milliseconds
  local window      = ARGV[3]           -- interval in milliseconds
  local incrementBy = ARGV[4]           -- increment rate per request at a given value, default is 1

  local requestsInCurrentWindow = redis.call("GET", currentKey)
  if requestsInCurrentWindow == false then
    requestsInCurrentWindow = 0
  end

  local requestsInPreviousWindow = redis.call("GET", previousKey)
  if requestsInPreviousWindow == false then
    requestsInPreviousWindow = 0
  end
  local percentageInCurrent = ( now % window ) / window
  -- weighted requests to consider from the previous window
  requestsInPreviousWindow = math.floor(( 1 - percentageInCurrent ) * requestsInPreviousWindow)
  if requestsInPreviousWindow + requestsInCurrentWindow >= tokens then
    return -1
  end

  local newValue = redis.call("INCRBY", currentKey, incrementBy)
  if newValue == tonumber(incrementBy) then
    -- The first time this key is set, the value will be equal to incrementBy.
    -- So we only need the expire command once
    redis.call("PEXPIRE", currentKey, window * 2 + 1000) -- Enough time to overlap with a new window + 1 second
  end
  return tokens - ( newValue + requestsInPreviousWindow )
`,Zr=`
  local currentKey  = KEYS[1]           -- identifier including prefixes
  local previousKey = KEYS[2]           -- key of the previous bucket
  local now         = ARGV[1]           -- current timestamp in milliseconds
  local window      = ARGV[2]           -- interval in milliseconds

  local requestsInCurrentWindow = redis.call("GET", currentKey)
  if requestsInCurrentWindow == false then
    requestsInCurrentWindow = 0
  end

  local requestsInPreviousWindow = redis.call("GET", previousKey)
  if requestsInPreviousWindow == false then
    requestsInPreviousWindow = 0
  end

  local percentageInCurrent = ( now % window ) / window
  -- weighted requests to consider from the previous window
  requestsInPreviousWindow = math.floor(( 1 - percentageInCurrent ) * requestsInPreviousWindow)

  return requestsInPreviousWindow + requestsInCurrentWindow
`,Qr=`
  local key         = KEYS[1]           -- identifier including prefixes
  local maxTokens   = tonumber(ARGV[1]) -- maximum number of tokens
  local interval    = tonumber(ARGV[2]) -- size of the window in milliseconds
  local refillRate  = tonumber(ARGV[3]) -- how many tokens are refilled after each interval
  local now         = tonumber(ARGV[4]) -- current timestamp in milliseconds
  local incrementBy = tonumber(ARGV[5]) -- how many tokens to consume, default is 1
        
  local bucket = redis.call("HMGET", key, "refilledAt", "tokens")
        
  local refilledAt
  local tokens

  if bucket[1] == false then
    refilledAt = now
    tokens = maxTokens
  else
    refilledAt = tonumber(bucket[1])
    tokens = tonumber(bucket[2])
  end
        
  if now >= refilledAt + interval then
    local numRefills = math.floor((now - refilledAt) / interval)
    tokens = math.min(maxTokens, tokens + numRefills * refillRate)

    refilledAt = refilledAt + numRefills * interval
  end

  if tokens == 0 then
    return {-1, refilledAt + interval}
  end

  local remaining = tokens - incrementBy
  local expireAt = math.ceil(((maxTokens - remaining) / refillRate)) * interval
        
  redis.call("HSET", key, "refilledAt", refilledAt, "tokens", remaining)
  redis.call("PEXPIRE", key, expireAt)
  return {remaining, refilledAt + interval}
`,Hi=-1,eo=`
  local key         = KEYS[1]
  local maxTokens   = tonumber(ARGV[1])
        
  local bucket = redis.call("HMGET", key, "refilledAt", "tokens")

  if bucket[1] == false then
    return {maxTokens, ${Hi}}
  end
        
  return {tonumber(bucket[2]), tonumber(bucket[1])}
`,to=`
  local key     = KEYS[1]
  local window  = ARGV[1]
  local incrementBy   = ARGV[2] -- increment rate per request at a given value, default is 1

  local r = redis.call("INCRBY", key, incrementBy)
  if r == incrementBy then
  -- The first time this key is set, the value will be equal to incrementBy.
  -- So we only need the expire command once
  redis.call("PEXPIRE", key, window)
  end
      
  return r
`,so=`
  local key = KEYS[1]
  local tokens = 0

  local value = redis.call('GET', key)
  if value then
      tokens = value
  end
  return tokens
`,no=`
	local key           = KEYS[1]
	local id            = ARGV[1]
	local window        = ARGV[2]
	local incrementBy   = tonumber(ARGV[3])

	redis.call("HSET", key, id, incrementBy)
	local fields = redis.call("HGETALL", key)
	if #fields == 2 and tonumber(fields[2])==incrementBy then
	-- The first time this key is set, and the value will be equal to incrementBy.
	-- So we only need the expire command once
	  redis.call("PEXPIRE", key, window)
	end

	return fields
`,io=`
      local key = KEYS[1]
      local tokens = 0

      local fields = redis.call("HGETALL", key)

      return fields
    `,ro=`
	local currentKey    = KEYS[1]           -- identifier including prefixes
	local previousKey   = KEYS[2]           -- key of the previous bucket
	local tokens        = tonumber(ARGV[1]) -- tokens per window
	local now           = ARGV[2]           -- current timestamp in milliseconds
	local window        = ARGV[3]           -- interval in milliseconds
	local requestId     = ARGV[4]           -- uuid for this request
	local incrementBy   = tonumber(ARGV[5]) -- custom rate, default is  1

	local currentFields = redis.call("HGETALL", currentKey)
	local requestsInCurrentWindow = 0
	for i = 2, #currentFields, 2 do
	requestsInCurrentWindow = requestsInCurrentWindow + tonumber(currentFields[i])
	end

	local previousFields = redis.call("HGETALL", previousKey)
	local requestsInPreviousWindow = 0
	for i = 2, #previousFields, 2 do
	requestsInPreviousWindow = requestsInPreviousWindow + tonumber(previousFields[i])
	end

	local percentageInCurrent = ( now % window) / window
	if requestsInPreviousWindow * (1 - percentageInCurrent ) + requestsInCurrentWindow >= tokens then
	  return {currentFields, previousFields, false}
	end

	redis.call("HSET", currentKey, requestId, incrementBy)

	if requestsInCurrentWindow == 0 then 
	  -- The first time this key is set, the value will be equal to incrementBy.
	  -- So we only need the expire command once
	  redis.call("PEXPIRE", currentKey, window * 2 + 1000) -- Enough time to overlap with a new window + 1 second
	end
	return {currentFields, previousFields, true}
`,oo=`
	local currentKey    = KEYS[1]           -- identifier including prefixes
	local previousKey   = KEYS[2]           -- key of the previous bucket
	local now         	= ARGV[1]           -- current timestamp in milliseconds
  	local window      	= ARGV[2]           -- interval in milliseconds

	local currentFields = redis.call("HGETALL", currentKey)
	local requestsInCurrentWindow = 0
	for i = 2, #currentFields, 2 do
	requestsInCurrentWindow = requestsInCurrentWindow + tonumber(currentFields[i])
	end

	local previousFields = redis.call("HGETALL", previousKey)
	local requestsInPreviousWindow = 0
	for i = 2, #previousFields, 2 do
	requestsInPreviousWindow = requestsInPreviousWindow + tonumber(previousFields[i])
	end

	local percentageInCurrent = ( now % window) / window
  	requestsInPreviousWindow = math.floor(( 1 - percentageInCurrent ) * requestsInPreviousWindow)
	
	return requestsInCurrentWindow + requestsInPreviousWindow
`,ao=`
      local pattern = KEYS[1]

      -- Initialize cursor to start from 0
      local cursor = "0"

      repeat
          -- Scan for keys matching the pattern
          local scan_result = redis.call('SCAN', cursor, 'MATCH', pattern)

          -- Extract cursor for the next iteration
          cursor = scan_result[1]

          -- Extract keys from the scan result
          local keys = scan_result[2]

          for i=1, #keys do
          redis.call('DEL', keys[i])
          end

      -- Continue scanning until cursor is 0 (end of keyspace)
      until cursor == "0"
    `,D={singleRegion:{fixedWindow:{limit:{script:Jr,hash:"b13943e359636db027ad280f1def143f02158c13"},getRemaining:{script:Xr,hash:"8c4c341934502aee132643ffbe58ead3450e5208"}},slidingWindow:{limit:{script:Yr,hash:"e1391e429b699c780eb0480350cd5b7280fd9213"},getRemaining:{script:Zr,hash:"65a73ac5a05bf9712903bc304b77268980c1c417"}},tokenBucket:{limit:{script:Qr,hash:"5bece90aeef8189a8cfd28995b479529e270b3c6"},getRemaining:{script:eo,hash:"a15be2bb1db2a15f7c82db06146f9d08983900d0"}},cachedFixedWindow:{limit:{script:to,hash:"c26b12703dd137939b9a69a3a9b18e906a2d940f"},getRemaining:{script:so,hash:"8e8f222ccae68b595ee6e3f3bf2199629a62b91a"}}},multiRegion:{fixedWindow:{limit:{script:no,hash:"a8c14f3835aa87bd70e5e2116081b81664abcf5c"},getRemaining:{script:io,hash:"8ab8322d0ed5fe5ac8eb08f0c2e4557f1b4816fd"}},slidingWindow:{limit:{script:ro,hash:"cb4fdc2575056df7c6d422764df0de3a08d6753b"},getRemaining:{script:oo,hash:"558c9306b7ec54abb50747fe0b17e5d44bd24868"}}}},G={script:ao,hash:"54bd274ddc59fb3be0f42deee2f64322a10e2b50"},V="denyList",zi="ipDenyList",Me="ipDenyListStatus",co=`
  -- Checks if values provideed in ARGV are present in the deny lists.
  -- This is done using the allDenyListsKey below.

  -- Additionally, checks the status of the ip deny list using the
  -- ipDenyListStatusKey below. Here are the possible states of the
  -- ipDenyListStatusKey key:
  -- * status == -1: set to "disabled" with no TTL
  -- * status == -2: not set, meaning that is was set before but expired
  -- * status  >  0: set to "valid", with a TTL
  --
  -- In the case of status == -2, we set the status to "pending" with
  -- 30 second ttl. During this time, the process which got status == -2
  -- will update the ip deny list.

  local allDenyListsKey     = KEYS[1]
  local ipDenyListStatusKey = KEYS[2]

  local results = redis.call('SMISMEMBER', allDenyListsKey, unpack(ARGV))
  local status  = redis.call('TTL', ipDenyListStatusKey)
  if status == -2 then
    redis.call('SETEX', ipDenyListStatusKey, 30, "pending")
  end

  return { results, status }
`,Wi={};Mi(Wi,{ThresholdError:()=>Gi,disableIpDenyList:()=>po,updateIpDenyList:()=>qi});var Ki=60*60*1e3,Ni=24*Ki,lo=2*Ki,ho=o(e=>{let s=((e||Date.now())-lo)%Ni;return Ni-s},"getIpListTTL"),uo="https://raw.githubusercontent.com/stamparm/ipsum/master/levels",Gi=o(class extends Error{constructor(e){super(`Allowed threshold values are from 1 to 8, 1 and 8 included. Received: ${e}`),this.name="ThresholdError"}},"ThresholdError"),mo=o(async e=>{if(typeof e!="number"||e<1||e>8)throw new Gi(e);try{let t=await fetch(`${uo}/${e}.txt`);if(!t.ok)throw new Error(`Error fetching data: ${t.statusText}`);return(await t.text()).split(`
`).filter(i=>i.length>0)}catch(t){throw new Error(`Failed to fetch ip deny list: ${t}`)}},"getIpDenyList"),qi=o(async(e,t,s,n)=>{let i=await mo(s),r=[t,V,"all"].join(":"),a=[t,V,zi].join(":"),c=[t,Me].join(":"),l=e.multi();return l.sdiffstore(r,r,a),l.del(a),l.sadd(a,i.at(0),...i.slice(1)),l.sdiffstore(a,a,r),l.sunionstore(r,r,a),l.set(c,"valid",{px:n??ho()}),await l.exec()},"updateIpDenyList"),po=o(async(e,t)=>{let s=[t,V,"all"].join(":"),n=[t,V,zi].join(":"),i=[t,Me].join(":"),r=e.multi();return r.sdiffstore(s,s,n),r.del(n),r.set(i,"disabled"),await r.exec()},"disableIpDenyList"),de=new me(new Map),fo=o(e=>e.find(t=>de.isBlocked(t).blocked),"checkDenyListCache"),wo=o(e=>{de.size()>1e3&&de.empty(),de.blockUntil(e,Date.now()+6e4)},"blockMember"),yo=o(async(e,t,s)=>{let[n,i]=await e.eval(co,[[t,V,"all"].join(":"),[t,Me].join(":")],s),r;return n.map((a,c)=>{a&&(wo(s[c]),r=s[c])}),{deniedValue:r,invalidIpDenyList:i===-2}},"checkDenyList"),xo=o((e,t,[s,n],i)=>{if(n.deniedValue&&(s.success=!1,s.remaining=0,s.reason="denyList",s.deniedValue=n.deniedValue),n.invalidIpDenyList){let r=qi(e,t,i);s.pending=Promise.all([s.pending,r])}return s},"resolveLimitPayload"),go=o(e=>({success:!1,limit:0,remaining:0,reset:0,pending:Promise.resolve(),reason:"denyList",deniedValue:e}),"defaultDeniedResponse"),$i=o(class{limiter;ctx;prefix;timeout;primaryRedis;analytics;enableProtection;denyListThreshold;constructor(e){this.ctx=e.ctx,this.limiter=e.limiter,this.timeout=e.timeout??5e3,this.prefix=e.prefix??"@upstash/ratelimit",this.enableProtection=e.enableProtection??!1,this.denyListThreshold=e.denyListThreshold??6,this.primaryRedis="redis"in this.ctx?this.ctx.redis:this.ctx.regionContexts[0].redis,this.analytics=e.analytics?new ji({redis:this.primaryRedis,prefix:this.prefix}):void 0,e.ephemeralCache instanceof Map?this.ctx.cache=new me(e.ephemeralCache):e.ephemeralCache===void 0&&(this.ctx.cache=new me(new Map))}limit=async(e,t)=>{let s=null;try{let n=this.getRatelimitResponse(e,t),{responseArray:i,newTimeoutId:r}=this.applyTimeout(n);s=r;let a=await Promise.race(i);return this.submitAnalytics(a,e,t)}finally{s&&clearTimeout(s)}};blockUntilReady=async(e,t)=>{if(t<=0)throw new Error("timeout must be positive");let s,n=Date.now()+t;for(;s=await this.limit(e),!s.success;){if(s.reset===0)throw new Error("This should not happen");let i=Math.min(s.reset,n)-Date.now();if(await new Promise(r=>setTimeout(r,i)),Date.now()>n)break}return s};resetUsedTokens=async e=>{let t=[this.prefix,e].join(":");await this.limiter().resetTokens(this.ctx,t)};getRemaining=async e=>{let t=[this.prefix,e].join(":");return await this.limiter().getRemaining(this.ctx,t)};getRatelimitResponse=async(e,t)=>{let s=this.getKey(e),n=this.getDefinedMembers(e,t),i=fo(n),r=i?[go(i),{deniedValue:i,invalidIpDenyList:!1}]:await Promise.all([this.limiter().limit(this.ctx,s,t?.rate),this.enableProtection?yo(this.primaryRedis,this.prefix,n):{deniedValue:void 0,invalidIpDenyList:!1}]);return xo(this.primaryRedis,this.prefix,r,this.denyListThreshold)};applyTimeout=e=>{let t=null,s=[e];if(this.timeout>0){let n=new Promise(i=>{t=setTimeout(()=>{i({success:!0,limit:0,remaining:0,reset:0,pending:Promise.resolve(),reason:"timeout"})},this.timeout)});s.push(n)}return{responseArray:s,newTimeoutId:t}};submitAnalytics=(e,t,s)=>{if(this.analytics)try{let n=s?this.analytics.extractGeo(s):void 0,i=this.analytics.record({identifier:e.reason==="denyList"?e.deniedValue:t,time:Date.now(),success:e.reason==="denyList"?"denied":e.success,...n}).catch(r=>{let a="Failed to record analytics";`${r}`.includes("WRONGTYPE")&&(a=`
    Failed to record analytics. See the information below:

    This can occur when you uprade to Ratelimit version 1.1.2
    or later from an earlier version.

    This occurs simply because the way we store analytics data
    has changed. To avoid getting this error, disable analytics
    for *an hour*, then simply enable it back.

    `),console.warn(a,r)});e.pending=Promise.all([e.pending,i])}catch(n){console.warn("Failed to record analytics",n)}return e};getKey=e=>[this.prefix,e].join(":");getDefinedMembers=(e,t)=>[e,t?.ip,t?.userAgent,t?.country].filter(n=>!!n)},"Ratelimit");function Bi(){let e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=t.length;for(let n=0;n<16;n++)e+=t.charAt(Math.floor(Math.random()*s));return e}o(Bi,"randomId");var vo=o(class extends $i{constructor(e){super({prefix:e.prefix,limiter:e.limiter,timeout:e.timeout,analytics:e.analytics,ctx:{regionContexts:e.redis.map(t=>({redis:t})),cache:e.ephemeralCache?new me(e.ephemeralCache):void 0}})}static fixedWindow(e,t){let s=M(t);return()=>({async limit(n,i,r){if(n.cache){let{blocked:m,reset:p}=n.cache.isBlocked(i);if(m)return{success:!1,limit:e,remaining:0,reset:p,pending:Promise.resolve(),reason:"cacheBlock"}}let a=Bi(),c=Math.floor(Date.now()/s),l=[i,c].join(":"),u=r?Math.max(1,r):1,d=n.regionContexts.map(m=>({redis:m.redis,request:T(m,D.multiRegion.fixedWindow.limit,[l],[a,s,u])})),y=(await Promise.any(d.map(m=>m.request))).reduce((m,p,w)=>{let v=0;return w%2&&(v=Number.parseInt(p)),m+v},0),x=e-y;async function g(){let m=await Promise.all(d.map(w=>w.request)),p=[...new Set(m.flat().reduce((w,v,E)=>(E%2===0&&w.push(v),w),[])).values()];for(let w of d){let E=(await w.request).reduce((k,C,I)=>{let P=0;return I%2&&(P=Number.parseInt(C)),k+P},0),_=(await w.request).reduce((k,C,I)=>(I%2===0&&k.push(C),k),[]);if(E>=e)continue;let A=p.filter(k=>!_.includes(k));if(A.length!==0)for(let k of A)await w.redis.hset(l,{[k]:u})}}o(g,"sync");let R=x>0,b=(c+1)*s;return n.cache&&!R&&n.cache.blockUntil(i,b),{success:R,limit:e,remaining:x,reset:b,pending:g()}},async getRemaining(n,i){let r=Math.floor(Date.now()/s),a=[i,r].join(":"),c=n.regionContexts.map(d=>({redis:d.redis,request:T(d,D.multiRegion.fixedWindow.getRemaining,[a],[null])})),u=(await Promise.any(c.map(d=>d.request))).reduce((d,f,y)=>{let x=0;return y%2&&(x=Number.parseInt(f)),d+x},0);return{remaining:Math.max(0,e-u),reset:(r+1)*s}},async resetTokens(n,i){let r=[i,"*"].join(":");n.cache&&n.cache.pop(i),await Promise.all(n.regionContexts.map(a=>{T(a,G,[r],[null])}))}})}static slidingWindow(e,t){let s=M(t),n=M(t);return()=>({async limit(i,r,a){if(i.cache){let{blocked:C,reset:I}=i.cache.isBlocked(r);if(C)return{success:!1,limit:e,remaining:0,reset:I,pending:Promise.resolve(),reason:"cacheBlock"}}let c=Bi(),l=Date.now(),u=Math.floor(l/s),d=[r,u].join(":"),f=u-1,y=[r,f].join(":"),x=a?Math.max(1,a):1,g=i.regionContexts.map(C=>({redis:C.redis,request:T(C,D.multiRegion.slidingWindow.limit,[d,y],[e,l,n,c,x])})),R=l%n/n,[b,m,p]=await Promise.any(g.map(C=>C.request));p&&b.push(c,x.toString());let w=m.reduce((C,I,P)=>{let L=0;return P%2&&(L=Number.parseInt(I)),C+L},0),v=b.reduce((C,I,P)=>{let L=0;return P%2&&(L=Number.parseInt(I)),C+L},0),S=Math.ceil(w*(1-R))+v,_=e-S;async function A(){let C=await Promise.all(g.map(P=>P.request)),I=[...new Set(C.flatMap(([P])=>P).reduce((P,L,je)=>(je%2===0&&P.push(L),P),[])).values()];for(let P of g){let[L,je,Ro]=await P.request,Zi=L.reduce((N,fe,we)=>(we%2===0&&N.push(fe),N),[]);if(L.reduce((N,fe,we)=>{let ze=0;return we%2&&(ze=Number.parseInt(fe)),N+ze},0)>=e)continue;let He=I.filter(N=>!Zi.includes(N));if(He.length!==0)for(let N of He)await P.redis.hset(d,{[N]:x})}}o(A,"sync");let k=(u+1)*n;return i.cache&&!p&&i.cache.blockUntil(r,k),{success:!!p,limit:e,remaining:Math.max(0,_),reset:k,pending:A()}},async getRemaining(i,r){let a=Date.now(),c=Math.floor(a/s),l=[r,c].join(":"),u=c-1,d=[r,u].join(":"),f=i.regionContexts.map(x=>({redis:x.redis,request:T(x,D.multiRegion.slidingWindow.getRemaining,[l,d],[a,s])})),y=await Promise.any(f.map(x=>x.request));return{remaining:Math.max(0,e-y),reset:(c+1)*s}},async resetTokens(i,r){let a=[r,"*"].join(":");i.cache&&i.cache.pop(r),await Promise.all(i.regionContexts.map(c=>{T(c,G,[a],[null])}))}})}},"MultiRegionRatelimit"),bo=o(class extends $i{constructor(e){super({prefix:e.prefix,limiter:e.limiter,timeout:e.timeout,analytics:e.analytics,ctx:{redis:e.redis},ephemeralCache:e.ephemeralCache,enableProtection:e.enableProtection,denyListThreshold:e.denyListThreshold})}static fixedWindow(e,t){let s=M(t);return()=>({async limit(n,i,r){let a=Math.floor(Date.now()/s),c=[i,a].join(":");if(n.cache){let{blocked:x,reset:g}=n.cache.isBlocked(i);if(x)return{success:!1,limit:e,remaining:0,reset:g,pending:Promise.resolve(),reason:"cacheBlock"}}let l=r?Math.max(1,r):1,u=await T(n,D.singleRegion.fixedWindow.limit,[c],[s,l]),d=u<=e,f=Math.max(0,e-u),y=(a+1)*s;return n.cache&&!d&&n.cache.blockUntil(i,y),{success:d,limit:e,remaining:f,reset:y,pending:Promise.resolve()}},async getRemaining(n,i){let r=Math.floor(Date.now()/s),a=[i,r].join(":"),c=await T(n,D.singleRegion.fixedWindow.getRemaining,[a],[null]);return{remaining:Math.max(0,e-c),reset:(r+1)*s}},async resetTokens(n,i){let r=[i,"*"].join(":");n.cache&&n.cache.pop(i),await T(n,G,[r],[null])}})}static slidingWindow(e,t){let s=M(t);return()=>({async limit(n,i,r){let a=Date.now(),c=Math.floor(a/s),l=[i,c].join(":"),u=c-1,d=[i,u].join(":");if(n.cache){let{blocked:R,reset:b}=n.cache.isBlocked(i);if(R)return{success:!1,limit:e,remaining:0,reset:b,pending:Promise.resolve(),reason:"cacheBlock"}}let f=r?Math.max(1,r):1,y=await T(n,D.singleRegion.slidingWindow.limit,[l,d],[e,a,s,f]),x=y>=0,g=(c+1)*s;return n.cache&&!x&&n.cache.blockUntil(i,g),{success:x,limit:e,remaining:Math.max(0,y),reset:g,pending:Promise.resolve()}},async getRemaining(n,i){let r=Date.now(),a=Math.floor(r/s),c=[i,a].join(":"),l=a-1,u=[i,l].join(":"),d=await T(n,D.singleRegion.slidingWindow.getRemaining,[c,u],[r,s]);return{remaining:Math.max(0,e-d),reset:(a+1)*s}},async resetTokens(n,i){let r=[i,"*"].join(":");n.cache&&n.cache.pop(i),await T(n,G,[r],[null])}})}static tokenBucket(e,t,s){let n=M(t);return()=>({async limit(i,r,a){if(i.cache){let{blocked:y,reset:x}=i.cache.isBlocked(r);if(y)return{success:!1,limit:s,remaining:0,reset:x,pending:Promise.resolve(),reason:"cacheBlock"}}let c=Date.now(),l=a?Math.max(1,a):1,[u,d]=await T(i,D.singleRegion.tokenBucket.limit,[r],[s,n,e,c,l]),f=u>=0;return i.cache&&!f&&i.cache.blockUntil(r,d),{success:f,limit:s,remaining:u,reset:d,pending:Promise.resolve()}},async getRemaining(i,r){let[a,c]=await T(i,D.singleRegion.tokenBucket.getRemaining,[r],[s]),l=Date.now()+n,u=c+n;return{remaining:a,reset:c===Hi?l:u}},async resetTokens(i,r){let a=r;i.cache&&i.cache.pop(r),await T(i,G,[a],[null])}})}static cachedFixedWindow(e,t){let s=M(t);return()=>({async limit(n,i,r){if(!n.cache)throw new Error("This algorithm requires a cache");let a=Math.floor(Date.now()/s),c=[i,a].join(":"),l=(a+1)*s,u=r?Math.max(1,r):1;if(typeof n.cache.get(c)=="number"){let x=n.cache.incr(c),g=x<e,R=g?T(n,D.singleRegion.cachedFixedWindow.limit,[c],[s,u]):Promise.resolve();return{success:g,limit:e,remaining:e-x,reset:l,pending:R}}let f=await T(n,D.singleRegion.cachedFixedWindow.limit,[c],[s,u]);n.cache.set(c,f);let y=e-f;return{success:y>=0,limit:e,remaining:y,reset:l,pending:Promise.resolve()}},async getRemaining(n,i){if(!n.cache)throw new Error("This algorithm requires a cache");let r=Math.floor(Date.now()/s),a=[i,r].join(":");if(typeof n.cache.get(a)=="number"){let u=n.cache.get(a)??0;return{remaining:Math.max(0,e-u),reset:(r+1)*s}}let l=await T(n,D.singleRegion.cachedFixedWindow.getRemaining,[a],[null]);return{remaining:Math.max(0,e-l),reset:(r+1)*s}},async resetTokens(n,i){if(!n.cache)throw new Error("This algorithm requires a cache");let r=Math.floor(Date.now()/s),a=[i,r].join(":");n.cache.pop(a);let c=[i,"*"].join(":");await T(n,G,[c],[null])}})}},"RegionRatelimit")});var Ke=o(async(e,t=Object.create(null))=>{let{all:s=!1,dot:n=!1}=t,r=(e instanceof J?e.raw.headers:e.headers).get("Content-Type");return r?.startsWith("multipart/form-data")||r?.startsWith("application/x-www-form-urlencoded")?rr(e,{all:s,dot:n}):{}},"parseBody");async function rr(e,t){let s=await e.formData();return s?or(s,t):{}}o(rr,"parseFormData");function or(e,t){let s=Object.create(null);return e.forEach((n,i)=>{t.all||i.endsWith("[]")?ar(s,i,n):s[i]=n}),t.dot&&Object.entries(s).forEach(([n,i])=>{n.includes(".")&&(cr(s,n,i),delete s[n])}),s}o(or,"convertFormDataToBodyData");var ar=o((e,t,s)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(s):e[t]=[e[t],s]:e[t]=s},"handleParsingAllValues"),cr=o((e,t,s)=>{let n=e,i=t.split(".");i.forEach((r,a)=>{a===i.length-1?n[r]=s:((!n[r]||typeof n[r]!="object"||Array.isArray(n[r])||n[r]instanceof File)&&(n[r]=Object.create(null)),n=n[r])})},"handleParsingNestedValues");var ve=o(e=>{let t=e.split("/");return t[0]===""&&t.shift(),t},"splitPath"),Ge=o(e=>{let{groups:t,path:s}=lr(e),n=ve(s);return hr(n,t)},"splitRoutingPath"),lr=o(e=>{let t=[];return e=e.replace(/\{[^}]+\}/g,(s,n)=>{let i=`@${n}`;return t.push([i,s]),i}),{groups:t,path:e}},"extractGroupsFromPath"),hr=o((e,t)=>{for(let s=t.length-1;s>=0;s--){let[n]=t[s];for(let i=e.length-1;i>=0;i--)if(e[i].includes(n)){e[i]=e[i].replace(n,t[s][1]);break}}return e},"replaceGroupMarks"),X={},be=o(e=>{if(e==="*")return"*";let t=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);return t?(X[e]||(t[2]?X[e]=[e,t[1],new RegExp("^"+t[2]+"$")]:X[e]=[e,t[1],!0]),X[e]):null},"getPattern"),ur=o(e=>{try{return decodeURI(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,t=>{try{return decodeURI(t)}catch{return t}})}},"tryDecodeURI"),Re=o(e=>{let t=e.url,s=t.indexOf("/",8),n=s;for(;n<t.length;n++){let i=t.charCodeAt(n);if(i===37){let r=t.indexOf("?",n),a=t.slice(s,r===-1?void 0:r);return ur(a.includes("%25")?a.replace(/%25/g,"%2525"):a)}else if(i===63)break}return t.slice(s,n)},"getPath");var qe=o(e=>{let t=Re(e);return t.length>1&&t[t.length-1]==="/"?t.slice(0,-1):t},"getPathNoStrict"),j=o((...e)=>{let t="",s=!1;for(let n of e)t[t.length-1]==="/"&&(t=t.slice(0,-1),s=!0),n[0]!=="/"&&(n=`/${n}`),n==="/"&&s?t=`${t}/`:n!=="/"&&(t=`${t}${n}`),n==="/"&&t===""&&(t="/");return t},"mergePath"),Y=o(e=>{if(!e.match(/\:.+\?$/))return null;let t=e.split("/"),s=[],n="";return t.forEach(i=>{if(i!==""&&!/\:/.test(i))n+="/"+i;else if(/\:/.test(i))if(/\?/.test(i)){s.length===0&&n===""?s.push("/"):s.push(n);let r=i.replace("?","");n+="/"+r,s.push(n)}else n+="/"+i}),s.filter((i,r,a)=>a.indexOf(i)===r)},"checkOptionalParameter"),ge=o(e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),/%/.test(e)?Z(e):e):e,"_decodeURI"),$e=o((e,t,s)=>{let n;if(!s&&t&&!/[%+]/.test(t)){let a=e.indexOf(`?${t}`,8);for(a===-1&&(a=e.indexOf(`&${t}`,8));a!==-1;){let c=e.charCodeAt(a+t.length+1);if(c===61){let l=a+t.length+2,u=e.indexOf("&",l);return ge(e.slice(l,u===-1?void 0:u))}else if(c==38||isNaN(c))return"";a=e.indexOf(`&${t}`,a+1)}if(n=/[%+]/.test(e),!n)return}let i={};n??=/[%+]/.test(e);let r=e.indexOf("?",8);for(;r!==-1;){let a=e.indexOf("&",r+1),c=e.indexOf("=",r);c>a&&a!==-1&&(c=-1);let l=e.slice(r+1,c===-1?a===-1?void 0:a:c);if(n&&(l=ge(l)),r=a,l==="")continue;let u;c===-1?u="":(u=e.slice(c+1,a===-1?void 0:a),n&&(u=ge(u))),s?(i[l]&&Array.isArray(i[l])||(i[l]=[]),i[l].push(u)):i[l]??=u}return t?i[t]:i},"_getQueryParam"),Fe=$e,Ve=o((e,t)=>$e(e,t,!0),"getQueryParams"),Z=decodeURIComponent;var J=o(class{raw;#s;#n;routeIndex=0;path;bodyCache={};constructor(e,t="/",s=[[]]){this.raw=e,this.path=t,this.#n=s,this.#s={}}param(e){return e?this.getDecodedParam(e):this.getAllDecodedParams()}getDecodedParam(e){let t=this.#n[0][this.routeIndex][1][e],s=this.getParamValue(t);return s?/\%/.test(s)?Z(s):s:void 0}getAllDecodedParams(){let e={},t=Object.keys(this.#n[0][this.routeIndex][1]);for(let s of t){let n=this.getParamValue(this.#n[0][this.routeIndex][1][s]);n&&typeof n=="string"&&(e[s]=/\%/.test(n)?Z(n):n)}return e}getParamValue(e){return this.#n[1]?this.#n[1][e]:e}query(e){return Fe(this.url,e)}queries(e){return Ve(this.url,e)}header(e){if(e)return this.raw.headers.get(e.toLowerCase())??void 0;let t={};return this.raw.headers.forEach((s,n)=>{t[n]=s}),t}async parseBody(e){return this.bodyCache.parsedBody??=await Ke(this,e)}cachedBody=e=>{let{bodyCache:t,raw:s}=this,n=t[e];if(n)return n;let i=Object.keys(t)[0];return i?t[i].then(r=>(i==="json"&&(r=JSON.stringify(r)),new Response(r)[e]())):t[e]=s[e]()};json(){return this.cachedBody("json")}text(){return this.cachedBody("text")}arrayBuffer(){return this.cachedBody("arrayBuffer")}blob(){return this.cachedBody("blob")}formData(){return this.cachedBody("formData")}addValidatedData(e,t){this.#s[e]=t}valid(e){return this.#s[e]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return this.#n[0].map(([[,e]])=>e)}get routePath(){return this.#n[0].map(([[,e]])=>e)[this.routeIndex].path}},"HonoRequest");var Je={Stringify:1,BeforeStream:2,Stream:3},dr=o((e,t)=>{let s=new String(e);return s.isEscaped=!0,s.callbacks=t,s},"raw");var Ee=o(async(e,t,s,n,i)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));let r=e.callbacks;if(!r?.length)return Promise.resolve(e);i?i[0]+=e:i=[e];let a=Promise.all(r.map(c=>c({phase:t,buffer:i,context:n}))).then(c=>Promise.all(c.filter(Boolean).map(l=>Ee(l,t,!1,n,i))).then(()=>i[0]));return s?dr(await a,r):a},"resolveCallback");var mr="text/plain; charset=UTF-8",Se=o((e,t={})=>(Object.entries(t).forEach(([s,n])=>e.set(s,n)),e),"setHeaders"),H=o(class{#s;#n;env={};#r;finalized=!1;error;#c=200;#o;#e;#t;#i;#a=!0;#u;#l;#h;#d;#m;constructor(e,t){this.#s=e,t&&(this.#o=t.executionCtx,this.env=t.env,this.#h=t.notFoundHandler,this.#m=t.path,this.#d=t.matchResult)}get req(){return this.#n??=new J(this.#s,this.#m,this.#d),this.#n}get event(){if(this.#o&&"respondWith"in this.#o)return this.#o;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#o)return this.#o;throw Error("This context has no ExecutionContext")}get res(){return this.#a=!1,this.#i||=new Response("404 Not Found",{status:404})}set res(e){if(this.#a=!1,this.#i&&e)try{for(let[t,s]of this.#i.headers.entries())if(t!=="content-type")if(t==="set-cookie"){let n=this.#i.headers.getSetCookie();e.headers.delete("set-cookie");for(let i of n)e.headers.append("set-cookie",i)}else e.headers.set(t,s)}catch(t){if(t instanceof TypeError&&t.message.includes("immutable")){this.res=new Response(e.body,{headers:e.headers,status:e.status});return}else throw t}this.#i=e,this.finalized=!0}render=(...e)=>(this.#l??=t=>this.html(t),this.#l(...e));setLayout=e=>this.#u=e;getLayout=()=>this.#u;setRenderer=e=>{this.#l=e};header=(e,t,s)=>{if(t===void 0){this.#e?this.#e.delete(e):this.#t&&delete this.#t[e.toLocaleLowerCase()],this.finalized&&this.res.headers.delete(e);return}s?.append?(this.#e||(this.#a=!1,this.#e=new Headers(this.#t),this.#t={}),this.#e.append(e,t)):this.#e?this.#e.set(e,t):(this.#t??={},this.#t[e.toLowerCase()]=t),this.finalized&&(s?.append?this.res.headers.append(e,t):this.res.headers.set(e,t))};status=e=>{this.#a=!1,this.#c=e};set=(e,t)=>{this.#r??=new Map,this.#r.set(e,t)};get=e=>this.#r?this.#r.get(e):void 0;get var(){return this.#r?Object.fromEntries(this.#r):{}}newResponse=(e,t,s)=>{if(this.#a&&!s&&!t&&this.#c===200)return new Response(e,{headers:this.#t});if(t&&typeof t!="number"){let i=new Headers(t.headers);this.#e&&this.#e.forEach((a,c)=>{c==="set-cookie"?i.append(c,a):i.set(c,a)});let r=Se(i,this.#t);return new Response(e,{headers:r,status:t.status??this.#c})}let n=typeof t=="number"?t:this.#c;this.#t??={},this.#e??=new Headers,Se(this.#e,this.#t),this.#i&&(this.#i.headers.forEach((i,r)=>{r==="set-cookie"?this.#e?.append(r,i):this.#e?.set(r,i)}),Se(this.#e,this.#t)),s??={};for(let[i,r]of Object.entries(s))if(typeof r=="string")this.#e.set(i,r);else{this.#e.delete(i);for(let a of r)this.#e.append(i,a)}return new Response(e,{status:n,headers:this.#e})};body=(e,t,s)=>typeof t=="number"?this.newResponse(e,t,s):this.newResponse(e,t);text=(e,t,s)=>{if(!this.#t){if(this.#a&&!s&&!t)return new Response(e);this.#t={}}return this.#t["content-type"]=mr,typeof t=="number"?this.newResponse(e,t,s):this.newResponse(e,t)};json=(e,t,s)=>{let n=JSON.stringify(e);return this.#t??={},this.#t["content-type"]="application/json; charset=UTF-8",typeof t=="number"?this.newResponse(n,t,s):this.newResponse(n,t)};html=(e,t,s)=>(this.#t??={},this.#t["content-type"]="text/html; charset=UTF-8",typeof e=="object"?Ee(e,Je.Stringify,!1,{}).then(n=>typeof t=="number"?this.newResponse(n,t,s):this.newResponse(n,t)):typeof t=="number"?this.newResponse(e,t,s):this.newResponse(e,t));redirect=(e,t)=>(this.#e??=new Headers,this.#e.set("Location",e),this.newResponse(null,t??302));notFound=()=>(this.#h??=()=>new Response,this.#h(this))},"Context");var Oe=o((e,t,s)=>(n,i)=>{let r=-1;return a(0);async function a(c){if(c<=r)throw new Error("next() called multiple times");r=c;let l,u=!1,d;if(e[c]?(d=e[c][0][0],n instanceof H&&(n.req.routeIndex=c)):d=c===e.length&&i||void 0,!d)n instanceof H&&n.finalized===!1&&s&&(l=await s(n));else try{l=await d(n,()=>a(c+1))}catch(f){if(f instanceof Error&&n instanceof H&&t)n.error=f,l=await t(f,n),u=!0;else throw f}return l&&(n.finalized===!1||u)&&(n.res=l),n}},"compose");var O="ALL",Xe="all",Ye=["get","post","put","delete","options","patch"],Q="Can not add a route since the matcher is already built.",ee=o(class extends Error{},"UnsupportedPathError");var pr=Symbol("composedHandler"),fr=o(e=>e.text("404 Not Found",404),"notFoundHandler"),Ze=o((e,t)=>"getResponse"in e?e.getResponse():(console.error(e),t.text("Internal Server Error",500)),"errorHandler"),ke=o(class{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#s="/";routes=[];constructor(e={}){[...Ye,Xe].forEach(n=>{this[n]=(i,...r)=>(typeof i=="string"?this.#s=i:this.addRoute(n,this.#s,i),r.forEach(a=>{typeof a!="string"&&this.addRoute(n,this.#s,a)}),this)}),this.on=(n,i,...r)=>{for(let a of[i].flat()){this.#s=a;for(let c of[n].flat())r.map(l=>{this.addRoute(c.toUpperCase(),this.#s,l)})}return this},this.use=(n,...i)=>(typeof n=="string"?this.#s=n:(this.#s="*",i.unshift(n)),i.forEach(r=>{this.addRoute(O,this.#s,r)}),this);let s=e.strict??!0;delete e.strict,Object.assign(this,e),this.getPath=s?e.getPath??Re:qe}clone(){let e=new ke({router:this.router,getPath:this.getPath});return e.routes=this.routes,e}notFoundHandler=fr;errorHandler=Ze;route(e,t){let s=this.basePath(e);return t.routes.map(n=>{let i;t.errorHandler===Ze?i=n.handler:(i=o(async(r,a)=>(await Oe([],t.errorHandler)(r,()=>n.handler(r,a))).res,"handler"),i[pr]=n.handler),s.addRoute(n.method,n.path,i)}),this}basePath(e){let t=this.clone();return t._basePath=j(this._basePath,e),t}onError=e=>(this.errorHandler=e,this);notFound=e=>(this.notFoundHandler=e,this);mount(e,t,s){let n,i;s&&(typeof s=="function"?i=s:(i=s.optionHandler,n=s.replaceRequest));let r=i?c=>{let l=i(c);return Array.isArray(l)?l:[l]}:c=>{let l;try{l=c.executionCtx}catch{}return[c.env,l]};n||=(()=>{let c=j(this._basePath,e),l=c==="/"?0:c.length;return u=>{let d=new URL(u.url);return d.pathname=d.pathname.slice(l)||"/",new Request(d,u)}})();let a=o(async(c,l)=>{let u=await t(n(c.req.raw),...r(c));if(u)return u;await l()},"handler");return this.addRoute(O,j(e,"*"),a),this}addRoute(e,t,s){e=e.toUpperCase(),t=j(this._basePath,t);let n={path:t,method:e,handler:s};this.router.add(e,t,[s,n]),this.routes.push(n)}matchRoute(e,t){return this.router.match(e,t)}handleError(e,t){if(e instanceof Error)return this.errorHandler(e,t);throw e}dispatch(e,t,s,n){if(n==="HEAD")return(async()=>new Response(null,await this.dispatch(e,t,s,"GET")))();let i=this.getPath(e,{env:s}),r=this.matchRoute(n,i),a=new H(e,{path:i,matchResult:r,env:s,executionCtx:t,notFoundHandler:this.notFoundHandler});if(r[0].length===1){let l;try{l=r[0][0][0][0](a,async()=>{a.res=await this.notFoundHandler(a)})}catch(u){return this.handleError(u,a)}return l instanceof Promise?l.then(u=>u||(a.finalized?a.res:this.notFoundHandler(a))).catch(u=>this.handleError(u,a)):l??this.notFoundHandler(a)}let c=Oe(r[0],this.errorHandler,this.notFoundHandler);return(async()=>{try{let l=await c(a);if(!l.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return l.res}catch(l){return this.handleError(l,a)}})()}fetch=(e,...t)=>this.dispatch(e,t[1],t[0],e.method);request=(e,t,s,n)=>{if(e instanceof Request)return t!==void 0&&(e=new Request(e,t)),this.fetch(e,s,n);e=e.toString();let i=/^https?:\/\//.test(e)?e:`http://localhost${j("/",e)}`,r=new Request(i,t);return this.fetch(r,s,n)};fire=()=>{addEventListener("fetch",e=>{e.respondWith(this.dispatch(e.request,e,void 0,e.request.method))})}},"Hono");var te="[^/]+",q=".*",$="(?:|/.*)",z=Symbol(),wr=new Set(".\\+*[^]$()");function yr(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===q||e===$?1:t===q||t===$?-1:e===te?1:t===te?-1:e.length===t.length?e<t?-1:1:t.length-e.length}o(yr,"compareKey");var se=o(class{index;varIndex;children=Object.create(null);insert(e,t,s,n,i){if(e.length===0){if(this.index!==void 0)throw z;if(i)return;this.index=t;return}let[r,...a]=e,c=r==="*"?a.length===0?["","",q]:["","",te]:r==="/*"?["","",$]:r.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),l;if(c){let u=c[1],d=c[2]||te;if(u&&c[2]&&(d=d.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(d)))throw z;if(l=this.children[d],!l){if(Object.keys(this.children).some(f=>f!==q&&f!==$))throw z;if(i)return;l=this.children[d]=new se,u!==""&&(l.varIndex=n.varIndex++)}!i&&u!==""&&s.push([u,l.varIndex])}else if(l=this.children[r],!l){if(Object.keys(this.children).some(u=>u.length>1&&u!==q&&u!==$))throw z;if(i)return;l=this.children[r]=new se}l.insert(a,t,s,n,i)}buildRegExpStr(){let t=Object.keys(this.children).sort(yr).map(s=>{let n=this.children[s];return(typeof n.varIndex=="number"?`(${s})@${n.varIndex}`:wr.has(s)?`\\${s}`:s)+n.buildRegExpStr()});return typeof this.index=="number"&&t.unshift(`#${this.index}`),t.length===0?"":t.length===1?t[0]:"(?:"+t.join("|")+")"}},"Node");var Qe=o(class{context={varIndex:0};root=new se;insert(e,t,s){let n=[],i=[];for(let a=0;;){let c=!1;if(e=e.replace(/\{[^}]+\}/g,l=>{let u=`@\\${a}`;return i[a]=[u,l],a++,c=!0,u}),!c)break}let r=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let a=i.length-1;a>=0;a--){let[c]=i[a];for(let l=r.length-1;l>=0;l--)if(r[l].indexOf(c)!==-1){r[l]=r[l].replace(c,i[a][1]);break}}return this.root.insert(r,t,n,this.context,s),n}buildRegExp(){let e=this.root.buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0,s=[],n=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(i,r,a)=>typeof r<"u"?(s[++t]=Number(r),"$()"):(typeof a<"u"&&(n[Number(a)]=++t),"")),[new RegExp(`^${e}`),s,n]}},"Trie");var et=[],xr=[/^$/,[],Object.create(null)],tt=Object.create(null);function st(e){return tt[e]??=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,s)=>s?`\\${s}`:"(?:|/.*)")}$`)}o(st,"buildWildcardRegExp");function gr(){tt=Object.create(null)}o(gr,"clearWildcardRegExpCache");function vr(e){let t=new Qe,s=[];if(e.length===0)return xr;let n=e.map(u=>[!/\*|\/:/.test(u[0]),...u]).sort(([u,d],[f,y])=>u?1:f?-1:d.length-y.length),i=Object.create(null);for(let u=0,d=-1,f=n.length;u<f;u++){let[y,x,g]=n[u];y?i[x]=[g.map(([b])=>[b,Object.create(null)]),et]:d++;let R;try{R=t.insert(x,d,y)}catch(b){throw b===z?new ee(x):b}y||(s[d]=g.map(([b,m])=>{let p=Object.create(null);for(m-=1;m>=0;m--){let[w,v]=R[m];p[w]=v}return[b,p]}))}let[r,a,c]=t.buildRegExp();for(let u=0,d=s.length;u<d;u++)for(let f=0,y=s[u].length;f<y;f++){let x=s[u][f]?.[1];if(!x)continue;let g=Object.keys(x);for(let R=0,b=g.length;R<b;R++)x[g[R]]=c[x[g[R]]]}let l=[];for(let u in a)l[u]=s[a[u]];return[r,l,i]}o(vr,"buildMatcherFromPreprocessedRoutes");function W(e,t){if(e){for(let s of Object.keys(e).sort((n,i)=>i.length-n.length))if(st(s).test(t))return[...e[s]]}}o(W,"findMiddleware");var Ce=o(class{name="RegExpRouter";middleware;routes;constructor(){this.middleware={[O]:Object.create(null)},this.routes={[O]:Object.create(null)}}add(e,t,s){let{middleware:n,routes:i}=this;if(!n||!i)throw new Error(Q);n[e]||[n,i].forEach(c=>{c[e]=Object.create(null),Object.keys(c[O]).forEach(l=>{c[e][l]=[...c[O][l]]})}),t==="/*"&&(t="*");let r=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){let c=st(t);e===O?Object.keys(n).forEach(l=>{n[l][t]||=W(n[l],t)||W(n[O],t)||[]}):n[e][t]||=W(n[e],t)||W(n[O],t)||[],Object.keys(n).forEach(l=>{(e===O||e===l)&&Object.keys(n[l]).forEach(u=>{c.test(u)&&n[l][u].push([s,r])})}),Object.keys(i).forEach(l=>{(e===O||e===l)&&Object.keys(i[l]).forEach(u=>c.test(u)&&i[l][u].push([s,r]))});return}let a=Y(t)||[t];for(let c=0,l=a.length;c<l;c++){let u=a[c];Object.keys(i).forEach(d=>{(e===O||e===d)&&(i[d][u]||=[...W(n[d],u)||W(n[O],u)||[]],i[d][u].push([s,r-l+c+1]))})}}match(e,t){gr();let s=this.buildAllMatchers();return this.match=(n,i)=>{let r=s[n]||s[O],a=r[2][i];if(a)return a;let c=i.match(r[0]);if(!c)return[[],et];let l=c.indexOf("",1);return[r[1][l],c]},this.match(e,t)}buildAllMatchers(){let e=Object.create(null);return[...Object.keys(this.routes),...Object.keys(this.middleware)].forEach(t=>{e[t]||=this.buildMatcher(t)}),this.middleware=this.routes=void 0,e}buildMatcher(e){let t=[],s=e===O;return[this.middleware,this.routes].forEach(n=>{let i=n[e]?Object.keys(n[e]).map(r=>[r,n[e][r]]):[];i.length!==0?(s||=!0,t.push(...i)):e!==O&&t.push(...Object.keys(n[O]).map(r=>[r,n[O][r]]))}),s?vr(t):null}},"RegExpRouter");var Te=o(class{name="SmartRouter";routers=[];routes=[];constructor(e){Object.assign(this,e)}add(e,t,s){if(!this.routes)throw new Error(Q);this.routes.push([e,t,s])}match(e,t){if(!this.routes)throw new Error("Fatal error");let{routers:s,routes:n}=this,i=s.length,r=0,a;for(;r<i;r++){let c=s[r];try{n.forEach(l=>{c.add(...l)}),a=c.match(e,t)}catch(l){if(l instanceof ee)continue;throw l}this.match=c.match.bind(c),this.routers=[c],this.routes=void 0;break}if(r===i)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,a}get activeRouter(){if(this.routes||this.routers.length!==1)throw new Error("No active router has been determined yet.");return this.routers[0]}},"SmartRouter");var Ae=o(class{methods;children;patterns;order=0;name;params=Object.create(null);constructor(e,t,s){if(this.children=s||Object.create(null),this.methods=[],this.name="",e&&t){let n=Object.create(null);n[e]={handler:t,possibleKeys:[],score:0,name:this.name},this.methods=[n]}this.patterns=[]}insert(e,t,s){this.name=`${e} ${t}`,this.order=++this.order;let n=this,i=Ge(t),r=[];for(let l=0,u=i.length;l<u;l++){let d=i[l];if(Object.keys(n.children).includes(d)){n=n.children[d];let y=be(d);y&&r.push(y[1]);continue}n.children[d]=new Ae;let f=be(d);f&&(n.patterns.push(f),r.push(f[1])),n=n.children[d]}n.methods.length||(n.methods=[]);let a=Object.create(null),c={handler:s,possibleKeys:r.filter((l,u,d)=>d.indexOf(l)===u),name:this.name,score:this.order};return a[e]=c,n.methods.push(a),n}gHSets(e,t,s,n){let i=[];for(let r=0,a=e.methods.length;r<a;r++){let c=e.methods[r],l=c[t]||c[O],u=Object.create(null);l!==void 0&&(l.params=Object.create(null),l.possibleKeys.forEach(d=>{let f=u[l.name];l.params[d]=n[d]&&!f?n[d]:s[d]??n[d],u[l.name]=!0}),i.push(l))}return i}search(e,t){let s=[];this.params=Object.create(null);let i=[this],r=ve(t);for(let c=0,l=r.length;c<l;c++){let u=r[c],d=c===l-1,f=[];for(let y=0,x=i.length;y<x;y++){let g=i[y],R=g.children[u];R&&(R.params=g.params,d===!0?(R.children["*"]&&s.push(...this.gHSets(R.children["*"],e,g.params,Object.create(null))),s.push(...this.gHSets(R,e,g.params,Object.create(null)))):f.push(R));for(let b=0,m=g.patterns.length;b<m;b++){let p=g.patterns[b],w={...g.params};if(p==="*"){let k=g.children["*"];k&&(s.push(...this.gHSets(k,e,g.params,Object.create(null))),f.push(k));continue}if(u==="")continue;let[v,E,S]=p,_=g.children[v],A=r.slice(c).join("/");if(S instanceof RegExp&&S.test(A)){w[E]=A,s.push(...this.gHSets(_,e,g.params,w));continue}(S===!0||S instanceof RegExp&&S.test(u))&&typeof v=="string"&&(w[E]=u,d===!0?(s.push(...this.gHSets(_,e,w,g.params)),_.children["*"]&&s.push(...this.gHSets(_.children["*"],e,w,g.params))):(_.params=w,f.push(_)))}}i=f}return[s.sort((c,l)=>c.score-l.score).map(({handler:c,params:l})=>[c,l])]}},"Node");var Pe=o(class{name="TrieRouter";node;constructor(){this.node=new Ae}add(e,t,s){let n=Y(t);if(n){for(let i of n)this.node.insert(e,i,s);return}this.node.insert(e,t,s)}match(e,t){return this.node.search(e,t)}},"TrieRouter");var B=o(class extends ke{constructor(e={}){super(e),this.router=e.router??new Te({routers:[new Ce,new Pe]})}},"Hono");var Ri=xe(ot(),1),Ei=xe(ct(),1);var br=Object.defineProperty,Rr=o((e,t)=>{for(var s in t)br(e,s,{get:t[s],enumerable:!0})},"__export"),Le={};Rr(Le,{UpstashError:()=>F,UrlError:()=>ut});var F=o(class extends Error{constructor(e){super(e),this.name="UpstashError"}},"UpstashError"),ut=o(class extends Error{constructor(e){super(`Upstash Redis client was passed an invalid URL. You should pass a URL starting with https. Received: "${e}". `),this.name="UrlError"}},"UrlError"),ae=o(class{baseUrl;headers;options;readYourWrites;upstashSyncToken="";hasCredentials;retry;constructor(e){this.options={backend:e.options?.backend,agent:e.agent,responseEncoding:e.responseEncoding??"base64",cache:e.cache,signal:e.signal,keepAlive:e.keepAlive??!0},this.upstashSyncToken="",this.readYourWrites=e.readYourWrites??!0,this.baseUrl=(e.baseUrl||"").replace(/\/$/,"");let t=/^https?:\/\/[^\s#$./?].\S*$/;if(this.baseUrl&&!t.test(this.baseUrl))throw new ut(this.baseUrl);this.headers={"Content-Type":"application/json",...e.headers},this.hasCredentials=!!(this.baseUrl&&this.headers.authorization.split(" ")[1]),this.options.responseEncoding==="base64"&&(this.headers["Upstash-Encoding"]="base64"),this.retry=typeof e.retry=="boolean"&&!e.retry?{attempts:1,backoff:()=>0}:{attempts:e.retry?.retries??5,backoff:e.retry?.backoff??(s=>Math.exp(s)*50)}}mergeTelemetry(e){this.headers=_e(this.headers,"Upstash-Telemetry-Runtime",e.runtime),this.headers=_e(this.headers,"Upstash-Telemetry-Platform",e.platform),this.headers=_e(this.headers,"Upstash-Telemetry-Sdk",e.sdk)}async request(e){let t={cache:this.options.cache,method:"POST",headers:this.headers,body:JSON.stringify(e.body),keepalive:this.options.keepAlive,agent:this.options.agent,signal:this.options.signal,backend:this.options.backend};if(this.hasCredentials||console.warn("[Upstash Redis] Redis client was initialized without url or token. Failed to execute command."),this.readYourWrites){let r=this.upstashSyncToken;this.headers["upstash-sync-token"]=r}let s=null,n=null;for(let r=0;r<=this.retry.attempts;r++)try{s=await fetch([this.baseUrl,...e.path??[]].join("/"),t);break}catch(a){if(this.options.signal?.aborted){let c=new Blob([JSON.stringify({result:this.options.signal.reason??"Aborted"})]),l={status:200,statusText:this.options.signal.reason??"Aborted"};s=new Response(c,l);break}n=a,await new Promise(c=>setTimeout(c,this.retry.backoff(r)))}if(!s)throw n??new Error("Exhausted all retries");let i=await s.json();if(!s.ok)throw new F(`${i.error}, command was: ${JSON.stringify(e.body)}`);if(this.readYourWrites){let r=s.headers;this.upstashSyncToken=r.get("upstash-sync-token")??""}if(this.readYourWrites){let r=s.headers;this.upstashSyncToken=r.get("upstash-sync-token")??""}return this.options.responseEncoding==="base64"?Array.isArray(i)?i.map(({result:a,error:c})=>({result:De(a),error:c})):{result:De(i.result),error:i.error}:i}},"HttpClient");function lt(e){let t="";try{let s=atob(e),n=s.length,i=new Uint8Array(n);for(let r=0;r<n;r++)i[r]=s.charCodeAt(r);t=new TextDecoder().decode(i)}catch{t=e}return t}o(lt,"base64decode");function De(e){let t;switch(typeof e){case"undefined":return e;case"number":{t=e;break}case"object":{Array.isArray(e)?t=e.map(s=>typeof s=="string"?lt(s):Array.isArray(s)?s.map(n=>De(n)):s):t=null;break}case"string":{t=e==="OK"?"OK":lt(e);break}default:break}return t}o(De,"decode");function _e(e,t,s){return s&&(e[t]=e[t]?[e[t],s].join(","):s),e}o(_e,"merge");function dt(e){let t=Array.isArray(e)?e.map(s=>{try{return dt(s)}catch{return s}}):JSON.parse(e);return typeof t=="number"&&t.toString()!==e?e:t}o(dt,"parseRecursive");function mt(e){try{return dt(e)}catch{return e}}o(mt,"parseResponse");function ce(e){return[e[0],...mt(e.slice(1))]}o(ce,"deserializeScanResponse");var Er=o(e=>{switch(typeof e){case"string":case"number":case"boolean":return e;default:return JSON.stringify(e)}},"defaultSerializer"),h=o(class{command;serialize;deserialize;constructor(e,t){if(this.serialize=Er,this.deserialize=t?.automaticDeserialization===void 0||t.automaticDeserialization?t?.deserialize??mt:s=>s,this.command=e.map(s=>this.serialize(s)),t?.latencyLogging){let s=this.exec.bind(this);this.exec=async n=>{let i=performance.now(),r=await s(n),c=(performance.now()-i).toFixed(2);return console.log(`Latency for \x1B[38;2;19;185;39m${this.command[0].toString().toUpperCase()}\x1B[0m: \x1B[38;2;0;255;255m${c} ms\x1B[0m`),r}}}async exec(e){let{result:t,error:s}=await e.request({body:this.command,upstashSyncToken:e.upstashSyncToken});if(s)throw new F(s);if(t===void 0)throw new TypeError("Request did not return a result");return this.deserialize(t)}},"Command");function Sr(e){if(e.length===0)return null;let t={};for(;e.length>=2;){let s=e.shift(),n=e.shift();try{t[s]=JSON.parse(n)}catch{t[s]=n}}return t}o(Sr,"deserialize");var pt=o(class extends h{constructor(e,t){let s=["hrandfield",e[0]];typeof e[1]=="number"&&s.push(e[1]),e[2]&&s.push("WITHVALUES"),super(s,{deserialize:e[2]?n=>Sr(n):t?.deserialize,...t})}},"HRandFieldCommand"),ft=o(class extends h{constructor(e,t){super(["append",...e],t)}},"AppendCommand"),wt=o(class extends h{constructor([e,t,s],n){let i=["bitcount",e];typeof t=="number"&&i.push(t),typeof s=="number"&&i.push(s),super(i,n)}},"BitCountCommand"),yt=o(class{constructor(e,t,s,n=i=>i.exec(this.client)){this.client=t,this.opts=s,this.execOperation=n,this.command=["bitfield",...e]}command;chain(...e){return this.command.push(...e),this}get(...e){return this.chain("get",...e)}set(...e){return this.chain("set",...e)}incrby(...e){return this.chain("incrby",...e)}overflow(e){return this.chain("overflow",e)}exec(){let e=new h(this.command,this.opts);return this.execOperation(e)}},"BitFieldCommand"),xt=o(class extends h{constructor(e,t){super(["bitop",...e],t)}},"BitOpCommand"),gt=o(class extends h{constructor(e,t){super(["bitpos",...e],t)}},"BitPosCommand"),vt=o(class extends h{constructor([e,t,s],n){super(["COPY",e,t,...s?.replace?["REPLACE"]:[]],{...n,deserialize(i){return i>0?"COPIED":"NOT_COPIED"}})}},"CopyCommand"),bt=o(class extends h{constructor(e){super(["dbsize"],e)}},"DBSizeCommand"),Rt=o(class extends h{constructor(e,t){super(["decr",...e],t)}},"DecrCommand"),Et=o(class extends h{constructor(e,t){super(["decrby",...e],t)}},"DecrByCommand"),St=o(class extends h{constructor(e,t){super(["del",...e],t)}},"DelCommand"),Ot=o(class extends h{constructor(e,t){super(["echo",...e],t)}},"EchoCommand"),kt=o(class extends h{constructor([e,t,s],n){super(["eval",e,t.length,...t,...s??[]],n)}},"EvalCommand"),Ct=o(class extends h{constructor([e,t,s],n){super(["evalsha",e,t.length,...t,...s??[]],n)}},"EvalshaCommand"),Tt=o(class extends h{constructor(e,t){super(["exists",...e],t)}},"ExistsCommand"),At=o(class extends h{constructor(e,t){super(["expire",...e.filter(Boolean)],t)}},"ExpireCommand"),Pt=o(class extends h{constructor(e,t){super(["expireat",...e],t)}},"ExpireAtCommand"),It=o(class extends h{constructor(e,t){let s=["flushall"];e&&e.length>0&&e[0].async&&s.push("async"),super(s,t)}},"FlushAllCommand"),_t=o(class extends h{constructor([e],t){let s=["flushdb"];e?.async&&s.push("async"),super(s,t)}},"FlushDBCommand"),Dt=o(class extends h{constructor([e,t,...s],n){let i=["geoadd",e];"nx"in t&&t.nx?i.push("nx"):"xx"in t&&t.xx&&i.push("xx"),"ch"in t&&t.ch&&i.push("ch"),"latitude"in t&&t.latitude&&i.push(t.longitude,t.latitude,t.member),i.push(...s.flatMap(({latitude:r,longitude:a,member:c})=>[a,r,c])),super(i,n)}},"GeoAddCommand"),Lt=o(class extends h{constructor([e,t,s,n="M"],i){super(["GEODIST",e,t,s,n],i)}},"GeoDistCommand"),Nt=o(class extends h{constructor(e,t){let[s]=e,n=Array.isArray(e[1])?e[1]:e.slice(1);super(["GEOHASH",s,...n],t)}},"GeoHashCommand"),Bt=o(class extends h{constructor(e,t){let[s]=e,n=Array.isArray(e[1])?e[1]:e.slice(1);super(["GEOPOS",s,...n],{deserialize:i=>Or(i),...t})}},"GeoPosCommand");function Or(e){let t=[];for(let s of e)!s?.[0]||!s?.[1]||t.push({lng:Number.parseFloat(s[0]),lat:Number.parseFloat(s[1])});return t}o(Or,"transform");var Mt=o(class extends h{constructor([e,t,s,n,i],r){let a=["GEOSEARCH",e];(t.type==="FROMMEMBER"||t.type==="frommember")&&a.push(t.type,t.member),(t.type==="FROMLONLAT"||t.type==="fromlonlat")&&a.push(t.type,t.coordinate.lon,t.coordinate.lat),(s.type==="BYRADIUS"||s.type==="byradius")&&a.push(s.type,s.radius,s.radiusType),(s.type==="BYBOX"||s.type==="bybox")&&a.push(s.type,s.rect.width,s.rect.height,s.rectType),a.push(n),i?.count&&a.push("COUNT",i.count.limit,...i.count.any?["ANY"]:[]);let c=o(l=>!i?.withCoord&&!i?.withDist&&!i?.withHash?l.map(u=>{try{return{member:JSON.parse(u)}}catch{return{member:u}}}):l.map(u=>{let d=1,f={};try{f.member=JSON.parse(u[0])}catch{f.member=u[0]}return i.withDist&&(f.dist=Number.parseFloat(u[d++])),i.withHash&&(f.hash=u[d++].toString()),i.withCoord&&(f.coord={long:Number.parseFloat(u[d][0]),lat:Number.parseFloat(u[d][1])}),f}),"transform2");super([...a,...i?.withCoord?["WITHCOORD"]:[],...i?.withDist?["WITHDIST"]:[],...i?.withHash?["WITHHASH"]:[]],{deserialize:c,...r})}},"GeoSearchCommand"),Ut=o(class extends h{constructor([e,t,s,n,i,r],a){let c=["GEOSEARCHSTORE",e,t];(s.type==="FROMMEMBER"||s.type==="frommember")&&c.push(s.type,s.member),(s.type==="FROMLONLAT"||s.type==="fromlonlat")&&c.push(s.type,s.coordinate.lon,s.coordinate.lat),(n.type==="BYRADIUS"||n.type==="byradius")&&c.push(n.type,n.radius,n.radiusType),(n.type==="BYBOX"||n.type==="bybox")&&c.push(n.type,n.rect.width,n.rect.height,n.rectType),c.push(i),r?.count&&c.push("COUNT",r.count.limit,...r.count.any?["ANY"]:[]),super([...c,...r?.storeDist?["STOREDIST"]:[]],a)}},"GeoSearchStoreCommand"),jt=o(class extends h{constructor(e,t){super(["get",...e],t)}},"GetCommand"),Ht=o(class extends h{constructor(e,t){super(["getbit",...e],t)}},"GetBitCommand"),zt=o(class extends h{constructor(e,t){super(["getdel",...e],t)}},"GetDelCommand"),Wt=o(class extends h{constructor(e,t){super(["getrange",...e],t)}},"GetRangeCommand"),Kt=o(class extends h{constructor(e,t){super(["getset",...e],t)}},"GetSetCommand"),Gt=o(class extends h{constructor(e,t){super(["hdel",...e],t)}},"HDelCommand"),qt=o(class extends h{constructor(e,t){super(["hexists",...e],t)}},"HExistsCommand"),$t=o(class extends h{constructor(e,t){super(["hget",...e],t)}},"HGetCommand");function kr(e){if(e.length===0)return null;let t={};for(;e.length>=2;){let s=e.shift(),n=e.shift();try{let i=!Number.isNaN(Number(n))&&!Number.isSafeInteger(Number(n));t[s]=i?n:JSON.parse(n)}catch{t[s]=n}}return t}o(kr,"deserialize2");var Ft=o(class extends h{constructor(e,t){super(["hgetall",...e],{deserialize:s=>kr(s),...t})}},"HGetAllCommand"),Vt=o(class extends h{constructor(e,t){super(["hincrby",...e],t)}},"HIncrByCommand"),Jt=o(class extends h{constructor(e,t){super(["hincrbyfloat",...e],t)}},"HIncrByFloatCommand"),Xt=o(class extends h{constructor([e],t){super(["hkeys",e],t)}},"HKeysCommand"),Yt=o(class extends h{constructor(e,t){super(["hlen",...e],t)}},"HLenCommand");function Cr(e,t){if(t.every(n=>n===null))return null;let s={};for(let[n,i]of e.entries())try{s[i]=JSON.parse(t[n])}catch{s[i]=t[n]}return s}o(Cr,"deserialize3");var Zt=o(class extends h{constructor([e,...t],s){super(["hmget",e,...t],{deserialize:n=>Cr(t,n),...s})}},"HMGetCommand"),Qt=o(class extends h{constructor([e,t],s){super(["hmset",e,...Object.entries(t).flatMap(([n,i])=>[n,i])],s)}},"HMSetCommand"),es=o(class extends h{constructor([e,t,s],n){let i=["hscan",e,t];s?.match&&i.push("match",s.match),typeof s?.count=="number"&&i.push("count",s.count),super(i,{deserialize:ce,...n})}},"HScanCommand"),ts=o(class extends h{constructor([e,t],s){super(["hset",e,...Object.entries(t).flatMap(([n,i])=>[n,i])],s)}},"HSetCommand"),ss=o(class extends h{constructor(e,t){super(["hsetnx",...e],t)}},"HSetNXCommand"),ns=o(class extends h{constructor(e,t){super(["hstrlen",...e],t)}},"HStrLenCommand"),is=o(class extends h{constructor(e,t){super(["hvals",...e],t)}},"HValsCommand"),rs=o(class extends h{constructor(e,t){super(["incr",...e],t)}},"IncrCommand"),os=o(class extends h{constructor(e,t){super(["incrby",...e],t)}},"IncrByCommand"),as=o(class extends h{constructor(e,t){super(["incrbyfloat",...e],t)}},"IncrByFloatCommand"),cs=o(class extends h{constructor(e,t){super(["JSON.ARRAPPEND",...e],t)}},"JsonArrAppendCommand"),ls=o(class extends h{constructor(e,t){super(["JSON.ARRINDEX",...e],t)}},"JsonArrIndexCommand"),hs=o(class extends h{constructor(e,t){super(["JSON.ARRINSERT",...e],t)}},"JsonArrInsertCommand"),us=o(class extends h{constructor(e,t){super(["JSON.ARRLEN",e[0],e[1]??"$"],t)}},"JsonArrLenCommand"),ds=o(class extends h{constructor(e,t){super(["JSON.ARRPOP",...e],t)}},"JsonArrPopCommand"),ms=o(class extends h{constructor(e,t){let s=e[1]??"$",n=e[2]??0,i=e[3]??0;super(["JSON.ARRTRIM",e[0],s,n,i],t)}},"JsonArrTrimCommand"),ps=o(class extends h{constructor(e,t){super(["JSON.CLEAR",...e],t)}},"JsonClearCommand"),fs=o(class extends h{constructor(e,t){super(["JSON.DEL",...e],t)}},"JsonDelCommand"),ws=o(class extends h{constructor(e,t){super(["JSON.FORGET",...e],t)}},"JsonForgetCommand"),ys=o(class extends h{constructor(e,t){let s=["JSON.GET"];typeof e[1]=="string"?s.push(...e):(s.push(e[0]),e[1]&&(e[1].indent&&s.push("INDENT",e[1].indent),e[1].newline&&s.push("NEWLINE",e[1].newline),e[1].space&&s.push("SPACE",e[1].space)),s.push(...e.slice(2))),super(s,t)}},"JsonGetCommand"),xs=o(class extends h{constructor(e,t){super(["JSON.MGET",...e[0],e[1]],t)}},"JsonMGetCommand"),gs=o(class extends h{constructor(e,t){let s=["JSON.MSET"];for(let n of e)s.push(n.key,n.path,n.value);super(s,t)}},"JsonMSetCommand"),vs=o(class extends h{constructor(e,t){super(["JSON.NUMINCRBY",...e],t)}},"JsonNumIncrByCommand"),bs=o(class extends h{constructor(e,t){super(["JSON.NUMMULTBY",...e],t)}},"JsonNumMultByCommand"),Rs=o(class extends h{constructor(e,t){super(["JSON.OBJKEYS",...e],t)}},"JsonObjKeysCommand"),Es=o(class extends h{constructor(e,t){super(["JSON.OBJLEN",...e],t)}},"JsonObjLenCommand"),Ss=o(class extends h{constructor(e,t){super(["JSON.RESP",...e],t)}},"JsonRespCommand"),Os=o(class extends h{constructor(e,t){let s=["JSON.SET",e[0],e[1],e[2]];e[3]&&(e[3].nx?s.push("NX"):e[3].xx&&s.push("XX")),super(s,t)}},"JsonSetCommand"),ks=o(class extends h{constructor(e,t){super(["JSON.STRAPPEND",...e],t)}},"JsonStrAppendCommand"),Cs=o(class extends h{constructor(e,t){super(["JSON.STRLEN",...e],t)}},"JsonStrLenCommand"),Ts=o(class extends h{constructor(e,t){super(["JSON.TOGGLE",...e],t)}},"JsonToggleCommand"),As=o(class extends h{constructor(e,t){super(["JSON.TYPE",...e],t)}},"JsonTypeCommand"),Ps=o(class extends h{constructor(e,t){super(["keys",...e],t)}},"KeysCommand"),Is=o(class extends h{constructor(e,t){super(["lindex",...e],t)}},"LIndexCommand"),_s=o(class extends h{constructor(e,t){super(["linsert",...e],t)}},"LInsertCommand"),Ds=o(class extends h{constructor(e,t){super(["llen",...e],t)}},"LLenCommand"),Ls=o(class extends h{constructor(e,t){super(["lmove",...e],t)}},"LMoveCommand"),Ns=o(class extends h{constructor(e,t){let[s,n,i,r]=e;super(["LMPOP",s,...n,i,...r?["COUNT",r]:[]],t)}},"LmPopCommand"),Bs=o(class extends h{constructor(e,t){super(["lpop",...e],t)}},"LPopCommand"),Ms=o(class extends h{constructor(e,t){let s=["lpos",e[0],e[1]];typeof e[2]?.rank=="number"&&s.push("rank",e[2].rank),typeof e[2]?.count=="number"&&s.push("count",e[2].count),typeof e[2]?.maxLen=="number"&&s.push("maxLen",e[2].maxLen),super(s,t)}},"LPosCommand"),Us=o(class extends h{constructor(e,t){super(["lpush",...e],t)}},"LPushCommand"),js=o(class extends h{constructor(e,t){super(["lpushx",...e],t)}},"LPushXCommand"),Hs=o(class extends h{constructor(e,t){super(["lrange",...e],t)}},"LRangeCommand"),zs=o(class extends h{constructor(e,t){super(["lrem",...e],t)}},"LRemCommand"),Ws=o(class extends h{constructor(e,t){super(["lset",...e],t)}},"LSetCommand"),Ks=o(class extends h{constructor(e,t){super(["ltrim",...e],t)}},"LTrimCommand"),Gs=o(class extends h{constructor(e,t){let s=Array.isArray(e[0])?e[0]:e;super(["mget",...s],t)}},"MGetCommand"),qs=o(class extends h{constructor([e],t){super(["mset",...Object.entries(e).flatMap(([s,n])=>[s,n])],t)}},"MSetCommand"),$s=o(class extends h{constructor([e],t){super(["msetnx",...Object.entries(e).flat()],t)}},"MSetNXCommand"),Fs=o(class extends h{constructor(e,t){super(["persist",...e],t)}},"PersistCommand"),Vs=o(class extends h{constructor(e,t){super(["pexpire",...e],t)}},"PExpireCommand"),Js=o(class extends h{constructor(e,t){super(["pexpireat",...e],t)}},"PExpireAtCommand"),Xs=o(class extends h{constructor(e,t){super(["pfadd",...e],t)}},"PfAddCommand"),Ys=o(class extends h{constructor(e,t){super(["pfcount",...e],t)}},"PfCountCommand"),Zs=o(class extends h{constructor(e,t){super(["pfmerge",...e],t)}},"PfMergeCommand"),Qs=o(class extends h{constructor(e,t){let s=["ping"];e?.[0]!==void 0&&s.push(e[0]),super(s,t)}},"PingCommand"),en=o(class extends h{constructor(e,t){super(["psetex",...e],t)}},"PSetEXCommand"),tn=o(class extends h{constructor(e,t){super(["pttl",...e],t)}},"PTtlCommand"),sn=o(class extends h{constructor(e,t){super(["publish",...e],t)}},"PublishCommand"),nn=o(class extends h{constructor(e){super(["randomkey"],e)}},"RandomKeyCommand"),rn=o(class extends h{constructor(e,t){super(["rename",...e],t)}},"RenameCommand"),on=o(class extends h{constructor(e,t){super(["renamenx",...e],t)}},"RenameNXCommand"),an=o(class extends h{constructor(e,t){super(["rpop",...e],t)}},"RPopCommand"),cn=o(class extends h{constructor(e,t){super(["rpush",...e],t)}},"RPushCommand"),ln=o(class extends h{constructor(e,t){super(["rpushx",...e],t)}},"RPushXCommand"),hn=o(class extends h{constructor(e,t){super(["sadd",...e],t)}},"SAddCommand"),un=o(class extends h{constructor([e,t],s){let n=["scan",e];t?.match&&n.push("match",t.match),typeof t?.count=="number"&&n.push("count",t.count),t?.type&&t.type.length>0&&n.push("type",t.type),super(n,{deserialize:ce,...s})}},"ScanCommand"),dn=o(class extends h{constructor(e,t){super(["scard",...e],t)}},"SCardCommand"),mn=o(class extends h{constructor(e,t){super(["script","exists",...e],{deserialize:s=>s,...t})}},"ScriptExistsCommand"),pn=o(class extends h{constructor([e],t){let s=["script","flush"];e?.sync?s.push("sync"):e?.async&&s.push("async"),super(s,t)}},"ScriptFlushCommand"),fn=o(class extends h{constructor(e,t){super(["script","load",...e],t)}},"ScriptLoadCommand"),wn=o(class extends h{constructor(e,t){super(["sdiff",...e],t)}},"SDiffCommand"),yn=o(class extends h{constructor(e,t){super(["sdiffstore",...e],t)}},"SDiffStoreCommand"),xn=o(class extends h{constructor([e,t,s],n){let i=["set",e,t];s&&("nx"in s&&s.nx?i.push("nx"):"xx"in s&&s.xx&&i.push("xx"),"get"in s&&s.get&&i.push("get"),"ex"in s&&typeof s.ex=="number"?i.push("ex",s.ex):"px"in s&&typeof s.px=="number"?i.push("px",s.px):"exat"in s&&typeof s.exat=="number"?i.push("exat",s.exat):"pxat"in s&&typeof s.pxat=="number"?i.push("pxat",s.pxat):"keepTtl"in s&&s.keepTtl&&i.push("keepTtl")),super(i,n)}},"SetCommand"),gn=o(class extends h{constructor(e,t){super(["setbit",...e],t)}},"SetBitCommand"),vn=o(class extends h{constructor(e,t){super(["setex",...e],t)}},"SetExCommand"),bn=o(class extends h{constructor(e,t){super(["setnx",...e],t)}},"SetNxCommand"),Rn=o(class extends h{constructor(e,t){super(["setrange",...e],t)}},"SetRangeCommand"),En=o(class extends h{constructor(e,t){super(["sinter",...e],t)}},"SInterCommand"),Sn=o(class extends h{constructor(e,t){super(["sinterstore",...e],t)}},"SInterStoreCommand"),On=o(class extends h{constructor(e,t){super(["sismember",...e],t)}},"SIsMemberCommand"),kn=o(class extends h{constructor(e,t){super(["smembers",...e],t)}},"SMembersCommand"),Cn=o(class extends h{constructor(e,t){super(["smismember",e[0],...e[1]],t)}},"SMIsMemberCommand"),Tn=o(class extends h{constructor(e,t){super(["smove",...e],t)}},"SMoveCommand"),An=o(class extends h{constructor([e,t],s){let n=["spop",e];typeof t=="number"&&n.push(t),super(n,s)}},"SPopCommand"),Pn=o(class extends h{constructor([e,t],s){let n=["srandmember",e];typeof t=="number"&&n.push(t),super(n,s)}},"SRandMemberCommand"),In=o(class extends h{constructor(e,t){super(["srem",...e],t)}},"SRemCommand"),_n=o(class extends h{constructor([e,t,s],n){let i=["sscan",e,t];s?.match&&i.push("match",s.match),typeof s?.count=="number"&&i.push("count",s.count),super(i,{deserialize:ce,...n})}},"SScanCommand"),Dn=o(class extends h{constructor(e,t){super(["strlen",...e],t)}},"StrLenCommand"),Ln=o(class extends h{constructor(e,t){super(["sunion",...e],t)}},"SUnionCommand"),Nn=o(class extends h{constructor(e,t){super(["sunionstore",...e],t)}},"SUnionStoreCommand"),Bn=o(class extends h{constructor(e){super(["time"],e)}},"TimeCommand"),Mn=o(class extends h{constructor(e,t){super(["touch",...e],t)}},"TouchCommand"),Un=o(class extends h{constructor(e,t){super(["ttl",...e],t)}},"TtlCommand"),jn=o(class extends h{constructor(e,t){super(["type",...e],t)}},"TypeCommand"),Hn=o(class extends h{constructor(e,t){super(["unlink",...e],t)}},"UnlinkCommand"),zn=o(class extends h{constructor([e,t,s],n){let i=Array.isArray(s)?[...s]:[s];super(["XACK",e,t,...i],n)}},"XAckCommand"),Wn=o(class extends h{constructor([e,t,s,n],i){let r=["XADD",e];n&&(n.nomkStream&&r.push("NOMKSTREAM"),n.trim&&(r.push(n.trim.type,n.trim.comparison,n.trim.threshold),n.trim.limit!==void 0&&r.push("LIMIT",n.trim.limit))),r.push(t);for(let[a,c]of Object.entries(s))r.push(a,c);super(r,i)}},"XAddCommand"),Kn=o(class extends h{constructor([e,t,s,n,i,r],a){let c=[];r?.count&&c.push("COUNT",r.count),r?.justId&&c.push("JUSTID"),super(["XAUTOCLAIM",e,t,s,n,i,...c],a)}},"XAutoClaim"),Gn=o(class extends h{constructor([e,t,s,n,i,r],a){let c=Array.isArray(i)?[...i]:[i],l=[];r?.idleMS&&l.push("IDLE",r.idleMS),r?.idleMS&&l.push("TIME",r.timeMS),r?.retryCount&&l.push("RETRYCOUNT",r.retryCount),r?.force&&l.push("FORCE"),r?.justId&&l.push("JUSTID"),r?.lastId&&l.push("LASTID",r.lastId),super(["XCLAIM",e,t,s,n,...c,...l],a)}},"XClaimCommand"),qn=o(class extends h{constructor([e,t],s){let n=Array.isArray(t)?[...t]:[t];super(["XDEL",e,...n],s)}},"XDelCommand"),$n=o(class extends h{constructor([e,t],s){let n=["XGROUP"];switch(t.type){case"CREATE":{n.push("CREATE",e,t.group,t.id),t.options&&(t.options.MKSTREAM&&n.push("MKSTREAM"),t.options.ENTRIESREAD!==void 0&&n.push("ENTRIESREAD",t.options.ENTRIESREAD.toString()));break}case"CREATECONSUMER":{n.push("CREATECONSUMER",e,t.group,t.consumer);break}case"DELCONSUMER":{n.push("DELCONSUMER",e,t.group,t.consumer);break}case"DESTROY":{n.push("DESTROY",e,t.group);break}case"SETID":{n.push("SETID",e,t.group,t.id),t.options?.ENTRIESREAD!==void 0&&n.push("ENTRIESREAD",t.options.ENTRIESREAD.toString());break}default:throw new Error("Invalid XGROUP")}super(n,s)}},"XGroupCommand"),Fn=o(class extends h{constructor([e,t],s){let n=[];t.type==="CONSUMERS"?n.push("CONSUMERS",e,t.group):n.push("GROUPS",e),super(["XINFO",...n],s)}},"XInfoCommand"),Vn=o(class extends h{constructor(e,t){super(["XLEN",...e],t)}},"XLenCommand"),Jn=o(class extends h{constructor([e,t,s,n,i,r],a){let c=r?.consumer===void 0?[]:Array.isArray(r.consumer)?[...r.consumer]:[r.consumer];super(["XPENDING",e,t,...r?.idleTime?["IDLE",r.idleTime]:[],s,n,i,...c],a)}},"XPendingCommand");function Tr(e){let t={};for(let s of e)for(;s.length>=2;){let n=s.shift(),i=s.shift();for((n in t)||(t[n]={});i.length>=2;){let r=i.shift(),a=i.shift();try{t[n][r]=JSON.parse(a)}catch{t[n][r]=a}}}return t}o(Tr,"deserialize4");var Xn=o(class extends h{constructor([e,t,s,n],i){let r=["XRANGE",e,t,s];typeof n=="number"&&r.push("COUNT",n),super(r,{deserialize:a=>Tr(a),...i})}},"XRangeCommand"),Ar="ERR Unbalanced XREAD list of streams: for each stream key an ID or '$' must be specified",Yn=o(class extends h{constructor([e,t,s],n){if(Array.isArray(e)&&Array.isArray(t)&&e.length!==t.length)throw new Error(Ar);let i=[];typeof s?.count=="number"&&i.push("COUNT",s.count),typeof s?.blockMS=="number"&&i.push("BLOCK",s.blockMS),i.push("STREAMS",...Array.isArray(e)?[...e]:[e],...Array.isArray(t)?[...t]:[t]),super(["XREAD",...i],n)}},"XReadCommand"),Pr="ERR Unbalanced XREADGROUP list of streams: for each stream key an ID or '$' must be specified",Zn=o(class extends h{constructor([e,t,s,n,i],r){if(Array.isArray(s)&&Array.isArray(n)&&s.length!==n.length)throw new Error(Pr);let a=[];typeof i?.count=="number"&&a.push("COUNT",i.count),typeof i?.blockMS=="number"&&a.push("BLOCK",i.blockMS),typeof i?.NOACK=="boolean"&&i.NOACK&&a.push("NOACK"),a.push("STREAMS",...Array.isArray(s)?[...s]:[s],...Array.isArray(n)?[...n]:[n]),super(["XREADGROUP","GROUP",e,t,...a],r)}},"XReadGroupCommand"),Qn=o(class extends h{constructor([e,t,s,n],i){let r=["XREVRANGE",e,t,s];typeof n=="number"&&r.push("COUNT",n),super(r,{deserialize:a=>Ir(a),...i})}},"XRevRangeCommand");function Ir(e){let t={};for(let s of e)for(;s.length>=2;){let n=s.shift(),i=s.shift();for((n in t)||(t[n]={});i.length>=2;){let r=i.shift(),a=i.shift();try{t[n][r]=JSON.parse(a)}catch{t[n][r]=a}}}return t}o(Ir,"deserialize5");var ei=o(class extends h{constructor([e,t],s){let{limit:n,strategy:i,threshold:r,exactness:a="~"}=t;super(["XTRIM",e,i,a,r,...n?["LIMIT",n]:[]],s)}},"XTrimCommand"),oe=o(class extends h{constructor([e,t,...s],n){let i=["zadd",e];"nx"in t&&t.nx?i.push("nx"):"xx"in t&&t.xx&&i.push("xx"),"ch"in t&&t.ch&&i.push("ch"),"incr"in t&&t.incr&&i.push("incr"),"lt"in t&&t.lt?i.push("lt"):"gt"in t&&t.gt&&i.push("gt"),"score"in t&&"member"in t&&i.push(t.score,t.member),i.push(...s.flatMap(({score:r,member:a})=>[r,a])),super(i,n)}},"ZAddCommand"),ti=o(class extends h{constructor(e,t){super(["zcard",...e],t)}},"ZCardCommand"),si=o(class extends h{constructor(e,t){super(["zcount",...e],t)}},"ZCountCommand"),ni=o(class extends h{constructor(e,t){super(["zincrby",...e],t)}},"ZIncrByCommand"),ii=o(class extends h{constructor([e,t,s,n],i){let r=["zinterstore",e,t];Array.isArray(s)?r.push(...s):r.push(s),n&&("weights"in n&&n.weights?r.push("weights",...n.weights):"weight"in n&&typeof n.weight=="number"&&r.push("weights",n.weight),"aggregate"in n&&r.push("aggregate",n.aggregate)),super(r,i)}},"ZInterStoreCommand"),ri=o(class extends h{constructor(e,t){super(["zlexcount",...e],t)}},"ZLexCountCommand"),oi=o(class extends h{constructor([e,t],s){let n=["zpopmax",e];typeof t=="number"&&n.push(t),super(n,s)}},"ZPopMaxCommand"),ai=o(class extends h{constructor([e,t],s){let n=["zpopmin",e];typeof t=="number"&&n.push(t),super(n,s)}},"ZPopMinCommand"),ci=o(class extends h{constructor([e,t,s,n],i){let r=["zrange",e,t,s];n?.byScore&&r.push("byscore"),n?.byLex&&r.push("bylex"),n?.rev&&r.push("rev"),n?.count!==void 0&&n.offset!==void 0&&r.push("limit",n.offset,n.count),n?.withScores&&r.push("withscores"),super(r,i)}},"ZRangeCommand"),li=o(class extends h{constructor(e,t){super(["zrank",...e],t)}},"ZRankCommand"),hi=o(class extends h{constructor(e,t){super(["zrem",...e],t)}},"ZRemCommand"),ui=o(class extends h{constructor(e,t){super(["zremrangebylex",...e],t)}},"ZRemRangeByLexCommand"),di=o(class extends h{constructor(e,t){super(["zremrangebyrank",...e],t)}},"ZRemRangeByRankCommand"),mi=o(class extends h{constructor(e,t){super(["zremrangebyscore",...e],t)}},"ZRemRangeByScoreCommand"),pi=o(class extends h{constructor(e,t){super(["zrevrank",...e],t)}},"ZRevRankCommand"),fi=o(class extends h{constructor([e,t,s],n){let i=["zscan",e,t];s?.match&&i.push("match",s.match),typeof s?.count=="number"&&i.push("count",s.count),super(i,{deserialize:ce,...n})}},"ZScanCommand"),wi=o(class extends h{constructor(e,t){super(["zscore",...e],t)}},"ZScoreCommand"),yi=o(class extends h{constructor([e,t,s],n){let i=["zunion",e];Array.isArray(t)?i.push(...t):i.push(t),s&&("weights"in s&&s.weights?i.push("weights",...s.weights):"weight"in s&&typeof s.weight=="number"&&i.push("weights",s.weight),"aggregate"in s&&i.push("aggregate",s.aggregate),s.withScores&&i.push("withscores")),super(i,n)}},"ZUnionCommand"),xi=o(class extends h{constructor([e,t,s,n],i){let r=["zunionstore",e,t];Array.isArray(s)?r.push(...s):r.push(s),n&&("weights"in n&&n.weights?r.push("weights",...n.weights):"weight"in n&&typeof n.weight=="number"&&r.push("weights",n.weight),"aggregate"in n&&r.push("aggregate",n.aggregate)),super(r,i)}},"ZUnionStoreCommand"),gi=o(class extends h{constructor(e,t){super(["zdiffstore",...e],t)}},"ZDiffStoreCommand"),vi=o(class extends h{constructor(e,t){let[s,n]=e;super(["zmscore",s,...n],t)}},"ZMScoreCommand"),ht=o(class{client;commands;commandOptions;multiExec;constructor(e){if(this.client=e.client,this.commands=[],this.commandOptions=e.commandOptions,this.multiExec=e.multiExec??!1,this.commandOptions?.latencyLogging){let t=this.exec.bind(this);this.exec=async s=>{let n=performance.now(),i=await(s?t(s):t()),a=(performance.now()-n).toFixed(2);return console.log(`Latency for \x1B[38;2;19;185;39m${this.multiExec?["MULTI-EXEC"]:["PIPELINE"].toString().toUpperCase()}\x1B[0m: \x1B[38;2;0;255;255m${a} ms\x1B[0m`),i}}}exec=async e=>{if(this.commands.length===0)throw new Error("Pipeline is empty");let t=this.multiExec?["multi-exec"]:["pipeline"],s=await this.client.request({path:t,body:Object.values(this.commands).map(n=>n.command)});return e?.keepErrors?s.map(({error:n,result:i},r)=>({error:n,result:this.commands[r].deserialize(i)})):s.map(({error:n,result:i},r)=>{if(n)throw new F(`Command ${r+1} [ ${this.commands[r].command[0]} ] failed: ${n}`);return this.commands[r].deserialize(i)})};length(){return this.commands.length}chain(e){return this.commands.push(e),this}append=(...e)=>this.chain(new ft(e,this.commandOptions));bitcount=(...e)=>this.chain(new wt(e,this.commandOptions));bitfield=(...e)=>new yt(e,this.client,this.commandOptions,this.chain.bind(this));bitop=(e,t,s,...n)=>this.chain(new xt([e,t,s,...n],this.commandOptions));bitpos=(...e)=>this.chain(new gt(e,this.commandOptions));copy=(...e)=>this.chain(new vt(e,this.commandOptions));zdiffstore=(...e)=>this.chain(new gi(e,this.commandOptions));dbsize=()=>this.chain(new bt(this.commandOptions));decr=(...e)=>this.chain(new Rt(e,this.commandOptions));decrby=(...e)=>this.chain(new Et(e,this.commandOptions));del=(...e)=>this.chain(new St(e,this.commandOptions));echo=(...e)=>this.chain(new Ot(e,this.commandOptions));eval=(...e)=>this.chain(new kt(e,this.commandOptions));evalsha=(...e)=>this.chain(new Ct(e,this.commandOptions));exists=(...e)=>this.chain(new Tt(e,this.commandOptions));expire=(...e)=>this.chain(new At(e,this.commandOptions));expireat=(...e)=>this.chain(new Pt(e,this.commandOptions));flushall=e=>this.chain(new It(e,this.commandOptions));flushdb=(...e)=>this.chain(new _t(e,this.commandOptions));geoadd=(...e)=>this.chain(new Dt(e,this.commandOptions));geodist=(...e)=>this.chain(new Lt(e,this.commandOptions));geopos=(...e)=>this.chain(new Bt(e,this.commandOptions));geohash=(...e)=>this.chain(new Nt(e,this.commandOptions));geosearch=(...e)=>this.chain(new Mt(e,this.commandOptions));geosearchstore=(...e)=>this.chain(new Ut(e,this.commandOptions));get=(...e)=>this.chain(new jt(e,this.commandOptions));getbit=(...e)=>this.chain(new Ht(e,this.commandOptions));getdel=(...e)=>this.chain(new zt(e,this.commandOptions));getrange=(...e)=>this.chain(new Wt(e,this.commandOptions));getset=(e,t)=>this.chain(new Kt([e,t],this.commandOptions));hdel=(...e)=>this.chain(new Gt(e,this.commandOptions));hexists=(...e)=>this.chain(new qt(e,this.commandOptions));hget=(...e)=>this.chain(new $t(e,this.commandOptions));hgetall=(...e)=>this.chain(new Ft(e,this.commandOptions));hincrby=(...e)=>this.chain(new Vt(e,this.commandOptions));hincrbyfloat=(...e)=>this.chain(new Jt(e,this.commandOptions));hkeys=(...e)=>this.chain(new Xt(e,this.commandOptions));hlen=(...e)=>this.chain(new Yt(e,this.commandOptions));hmget=(...e)=>this.chain(new Zt(e,this.commandOptions));hmset=(e,t)=>this.chain(new Qt([e,t],this.commandOptions));hrandfield=(e,t,s)=>this.chain(new pt([e,t,s],this.commandOptions));hscan=(...e)=>this.chain(new es(e,this.commandOptions));hset=(e,t)=>this.chain(new ts([e,t],this.commandOptions));hsetnx=(e,t,s)=>this.chain(new ss([e,t,s],this.commandOptions));hstrlen=(...e)=>this.chain(new ns(e,this.commandOptions));hvals=(...e)=>this.chain(new is(e,this.commandOptions));incr=(...e)=>this.chain(new rs(e,this.commandOptions));incrby=(...e)=>this.chain(new os(e,this.commandOptions));incrbyfloat=(...e)=>this.chain(new as(e,this.commandOptions));keys=(...e)=>this.chain(new Ps(e,this.commandOptions));lindex=(...e)=>this.chain(new Is(e,this.commandOptions));linsert=(e,t,s,n)=>this.chain(new _s([e,t,s,n],this.commandOptions));llen=(...e)=>this.chain(new Ds(e,this.commandOptions));lmove=(...e)=>this.chain(new Ls(e,this.commandOptions));lpop=(...e)=>this.chain(new Bs(e,this.commandOptions));lmpop=(...e)=>this.chain(new Ns(e,this.commandOptions));lpos=(...e)=>this.chain(new Ms(e,this.commandOptions));lpush=(e,...t)=>this.chain(new Us([e,...t],this.commandOptions));lpushx=(e,...t)=>this.chain(new js([e,...t],this.commandOptions));lrange=(...e)=>this.chain(new Hs(e,this.commandOptions));lrem=(e,t,s)=>this.chain(new zs([e,t,s],this.commandOptions));lset=(e,t,s)=>this.chain(new Ws([e,t,s],this.commandOptions));ltrim=(...e)=>this.chain(new Ks(e,this.commandOptions));mget=(...e)=>this.chain(new Gs(e,this.commandOptions));mset=e=>this.chain(new qs([e],this.commandOptions));msetnx=e=>this.chain(new $s([e],this.commandOptions));persist=(...e)=>this.chain(new Fs(e,this.commandOptions));pexpire=(...e)=>this.chain(new Vs(e,this.commandOptions));pexpireat=(...e)=>this.chain(new Js(e,this.commandOptions));pfadd=(...e)=>this.chain(new Xs(e,this.commandOptions));pfcount=(...e)=>this.chain(new Ys(e,this.commandOptions));pfmerge=(...e)=>this.chain(new Zs(e,this.commandOptions));ping=e=>this.chain(new Qs(e,this.commandOptions));psetex=(e,t,s)=>this.chain(new en([e,t,s],this.commandOptions));pttl=(...e)=>this.chain(new tn(e,this.commandOptions));publish=(...e)=>this.chain(new sn(e,this.commandOptions));randomkey=()=>this.chain(new nn(this.commandOptions));rename=(...e)=>this.chain(new rn(e,this.commandOptions));renamenx=(...e)=>this.chain(new on(e,this.commandOptions));rpop=(...e)=>this.chain(new an(e,this.commandOptions));rpush=(e,...t)=>this.chain(new cn([e,...t],this.commandOptions));rpushx=(e,...t)=>this.chain(new ln([e,...t],this.commandOptions));sadd=(e,t,...s)=>this.chain(new hn([e,t,...s],this.commandOptions));scan=(...e)=>this.chain(new un(e,this.commandOptions));scard=(...e)=>this.chain(new dn(e,this.commandOptions));scriptExists=(...e)=>this.chain(new mn(e,this.commandOptions));scriptFlush=(...e)=>this.chain(new pn(e,this.commandOptions));scriptLoad=(...e)=>this.chain(new fn(e,this.commandOptions));sdiff=(...e)=>this.chain(new wn(e,this.commandOptions));sdiffstore=(...e)=>this.chain(new yn(e,this.commandOptions));set=(e,t,s)=>this.chain(new xn([e,t,s],this.commandOptions));setbit=(...e)=>this.chain(new gn(e,this.commandOptions));setex=(e,t,s)=>this.chain(new vn([e,t,s],this.commandOptions));setnx=(e,t)=>this.chain(new bn([e,t],this.commandOptions));setrange=(...e)=>this.chain(new Rn(e,this.commandOptions));sinter=(...e)=>this.chain(new En(e,this.commandOptions));sinterstore=(...e)=>this.chain(new Sn(e,this.commandOptions));sismember=(e,t)=>this.chain(new On([e,t],this.commandOptions));smembers=(...e)=>this.chain(new kn(e,this.commandOptions));smismember=(e,t)=>this.chain(new Cn([e,t],this.commandOptions));smove=(e,t,s)=>this.chain(new Tn([e,t,s],this.commandOptions));spop=(...e)=>this.chain(new An(e,this.commandOptions));srandmember=(...e)=>this.chain(new Pn(e,this.commandOptions));srem=(e,...t)=>this.chain(new In([e,...t],this.commandOptions));sscan=(...e)=>this.chain(new _n(e,this.commandOptions));strlen=(...e)=>this.chain(new Dn(e,this.commandOptions));sunion=(...e)=>this.chain(new Ln(e,this.commandOptions));sunionstore=(...e)=>this.chain(new Nn(e,this.commandOptions));time=()=>this.chain(new Bn(this.commandOptions));touch=(...e)=>this.chain(new Mn(e,this.commandOptions));ttl=(...e)=>this.chain(new Un(e,this.commandOptions));type=(...e)=>this.chain(new jn(e,this.commandOptions));unlink=(...e)=>this.chain(new Hn(e,this.commandOptions));zadd=(...e)=>"score"in e[1]?this.chain(new oe([e[0],e[1],...e.slice(2)],this.commandOptions)):this.chain(new oe([e[0],e[1],...e.slice(2)],this.commandOptions));xadd=(...e)=>this.chain(new Wn(e,this.commandOptions));xack=(...e)=>this.chain(new zn(e,this.commandOptions));xdel=(...e)=>this.chain(new qn(e,this.commandOptions));xgroup=(...e)=>this.chain(new $n(e,this.commandOptions));xread=(...e)=>this.chain(new Yn(e,this.commandOptions));xreadgroup=(...e)=>this.chain(new Zn(e,this.commandOptions));xinfo=(...e)=>this.chain(new Fn(e,this.commandOptions));xlen=(...e)=>this.chain(new Vn(e,this.commandOptions));xpending=(...e)=>this.chain(new Jn(e,this.commandOptions));xclaim=(...e)=>this.chain(new Gn(e,this.commandOptions));xautoclaim=(...e)=>this.chain(new Kn(e,this.commandOptions));xtrim=(...e)=>this.chain(new ei(e,this.commandOptions));xrange=(...e)=>this.chain(new Xn(e,this.commandOptions));xrevrange=(...e)=>this.chain(new Qn(e,this.commandOptions));zcard=(...e)=>this.chain(new ti(e,this.commandOptions));zcount=(...e)=>this.chain(new si(e,this.commandOptions));zincrby=(e,t,s)=>this.chain(new ni([e,t,s],this.commandOptions));zinterstore=(...e)=>this.chain(new ii(e,this.commandOptions));zlexcount=(...e)=>this.chain(new ri(e,this.commandOptions));zmscore=(...e)=>this.chain(new vi(e,this.commandOptions));zpopmax=(...e)=>this.chain(new oi(e,this.commandOptions));zpopmin=(...e)=>this.chain(new ai(e,this.commandOptions));zrange=(...e)=>this.chain(new ci(e,this.commandOptions));zrank=(e,t)=>this.chain(new li([e,t],this.commandOptions));zrem=(e,...t)=>this.chain(new hi([e,...t],this.commandOptions));zremrangebylex=(...e)=>this.chain(new ui(e,this.commandOptions));zremrangebyrank=(...e)=>this.chain(new di(e,this.commandOptions));zremrangebyscore=(...e)=>this.chain(new mi(e,this.commandOptions));zrevrank=(e,t)=>this.chain(new pi([e,t],this.commandOptions));zscan=(...e)=>this.chain(new fi(e,this.commandOptions));zscore=(e,t)=>this.chain(new wi([e,t],this.commandOptions));zunionstore=(...e)=>this.chain(new xi(e,this.commandOptions));zunion=(...e)=>this.chain(new yi(e,this.commandOptions));get json(){return{arrappend:(...e)=>this.chain(new cs(e,this.commandOptions)),arrindex:(...e)=>this.chain(new ls(e,this.commandOptions)),arrinsert:(...e)=>this.chain(new hs(e,this.commandOptions)),arrlen:(...e)=>this.chain(new us(e,this.commandOptions)),arrpop:(...e)=>this.chain(new ds(e,this.commandOptions)),arrtrim:(...e)=>this.chain(new ms(e,this.commandOptions)),clear:(...e)=>this.chain(new ps(e,this.commandOptions)),del:(...e)=>this.chain(new fs(e,this.commandOptions)),forget:(...e)=>this.chain(new ws(e,this.commandOptions)),get:(...e)=>this.chain(new ys(e,this.commandOptions)),mget:(...e)=>this.chain(new xs(e,this.commandOptions)),mset:(...e)=>this.chain(new gs(e,this.commandOptions)),numincrby:(...e)=>this.chain(new vs(e,this.commandOptions)),nummultby:(...e)=>this.chain(new bs(e,this.commandOptions)),objkeys:(...e)=>this.chain(new Rs(e,this.commandOptions)),objlen:(...e)=>this.chain(new Es(e,this.commandOptions)),resp:(...e)=>this.chain(new Ss(e,this.commandOptions)),set:(...e)=>this.chain(new Os(e,this.commandOptions)),strappend:(...e)=>this.chain(new ks(e,this.commandOptions)),strlen:(...e)=>this.chain(new Cs(e,this.commandOptions)),toggle:(...e)=>this.chain(new Ts(e,this.commandOptions)),type:(...e)=>this.chain(new As(e,this.commandOptions))}}},"Pipeline");function bi(e,t){let s=e;return s.autoPipelineExecutor||(s.autoPipelineExecutor=new _r(s)),new Proxy(s,{get:(n,i)=>i==="pipelineCounter"?n.autoPipelineExecutor.pipelineCounter:i==="json"?bi(n,!0):i in n&&!(i in n.autoPipelineExecutor.pipeline)?n[i]:(t?typeof n.autoPipelineExecutor.pipeline.json[i]=="function":typeof n.autoPipelineExecutor.pipeline[i]=="function")?(...c)=>n.autoPipelineExecutor.withAutoPipeline(l=>{t?l.json[i](...c):l[i](...c)}):n.autoPipelineExecutor.pipeline[i]})}o(bi,"createAutoPipelineProxy");var _r=o(class{pipelinePromises=new WeakMap;activePipeline=null;indexInCurrentPipeline=0;redis;pipeline;pipelineCounter=0;constructor(e){this.redis=e,this.pipeline=e.pipeline()}async withAutoPipeline(e){let t=this.activePipeline??this.redis.pipeline();this.activePipeline||(this.activePipeline=t,this.indexInCurrentPipeline=0);let s=this.indexInCurrentPipeline++;e(t);let r=(await this.deferExecution().then(()=>{if(!this.pipelinePromises.has(t)){let a=t.exec({keepErrors:!0});this.pipelineCounter+=1,this.pipelinePromises.set(t,a),this.activePipeline=null}return this.pipelinePromises.get(t)}))[s];if(r.error)throw new F(`Command failed: ${r.error}`);return r.result}async deferExecution(){await Promise.resolve(),await Promise.resolve()}},"AutoPipelineExecutor"),Dr=o(class{script;sha1;redis;constructor(e,t){this.redis=e,this.sha1=this.digest(t),this.script=t}async eval(e,t){return await this.redis.eval(this.script,e,t)}async evalsha(e,t){return await this.redis.evalsha(this.sha1,e,t)}async exec(e,t){return await this.redis.evalsha(this.sha1,e,t).catch(async n=>{if(n instanceof Error&&n.message.toLowerCase().includes("noscript"))return await this.redis.eval(this.script,e,t);throw n})}digest(e){return Ri.default.stringify((0,Ei.default)(e))}},"Script"),le=o(class{client;opts;enableTelemetry;enableAutoPipelining;constructor(e,t){this.client=e,this.opts=t,this.enableTelemetry=t?.enableTelemetry??!0,t?.readYourWrites===!1&&(this.client.readYourWrites=!1),this.enableAutoPipelining=t?.enableAutoPipelining??!0}get readYourWritesSyncToken(){return this.client.upstashSyncToken}set readYourWritesSyncToken(e){this.client.upstashSyncToken=e}get json(){return{arrappend:(...e)=>new cs(e,this.opts).exec(this.client),arrindex:(...e)=>new ls(e,this.opts).exec(this.client),arrinsert:(...e)=>new hs(e,this.opts).exec(this.client),arrlen:(...e)=>new us(e,this.opts).exec(this.client),arrpop:(...e)=>new ds(e,this.opts).exec(this.client),arrtrim:(...e)=>new ms(e,this.opts).exec(this.client),clear:(...e)=>new ps(e,this.opts).exec(this.client),del:(...e)=>new fs(e,this.opts).exec(this.client),forget:(...e)=>new ws(e,this.opts).exec(this.client),get:(...e)=>new ys(e,this.opts).exec(this.client),mget:(...e)=>new xs(e,this.opts).exec(this.client),mset:(...e)=>new gs(e,this.opts).exec(this.client),numincrby:(...e)=>new vs(e,this.opts).exec(this.client),nummultby:(...e)=>new bs(e,this.opts).exec(this.client),objkeys:(...e)=>new Rs(e,this.opts).exec(this.client),objlen:(...e)=>new Es(e,this.opts).exec(this.client),resp:(...e)=>new Ss(e,this.opts).exec(this.client),set:(...e)=>new Os(e,this.opts).exec(this.client),strappend:(...e)=>new ks(e,this.opts).exec(this.client),strlen:(...e)=>new Cs(e,this.opts).exec(this.client),toggle:(...e)=>new Ts(e,this.opts).exec(this.client),type:(...e)=>new As(e,this.opts).exec(this.client)}}use=e=>{let t=this.client.request.bind(this.client);this.client.request=s=>e(s,t)};addTelemetry=e=>{if(this.enableTelemetry)try{this.client.mergeTelemetry(e)}catch{}};createScript(e){return new Dr(this,e)}pipeline=()=>new ht({client:this.client,commandOptions:this.opts,multiExec:!1});autoPipeline=()=>bi(this);multi=()=>new ht({client:this.client,commandOptions:this.opts,multiExec:!0});bitfield=(...e)=>new yt(e,this.client,this.opts);append=(...e)=>new ft(e,this.opts).exec(this.client);bitcount=(...e)=>new wt(e,this.opts).exec(this.client);bitop=(e,t,s,...n)=>new xt([e,t,s,...n],this.opts).exec(this.client);bitpos=(...e)=>new gt(e,this.opts).exec(this.client);copy=(...e)=>new vt(e,this.opts).exec(this.client);dbsize=()=>new bt(this.opts).exec(this.client);decr=(...e)=>new Rt(e,this.opts).exec(this.client);decrby=(...e)=>new Et(e,this.opts).exec(this.client);del=(...e)=>new St(e,this.opts).exec(this.client);echo=(...e)=>new Ot(e,this.opts).exec(this.client);eval=(...e)=>new kt(e,this.opts).exec(this.client);evalsha=(...e)=>new Ct(e,this.opts).exec(this.client);exists=(...e)=>new Tt(e,this.opts).exec(this.client);expire=(...e)=>new At(e,this.opts).exec(this.client);expireat=(...e)=>new Pt(e,this.opts).exec(this.client);flushall=e=>new It(e,this.opts).exec(this.client);flushdb=(...e)=>new _t(e,this.opts).exec(this.client);geoadd=(...e)=>new Dt(e,this.opts).exec(this.client);geopos=(...e)=>new Bt(e,this.opts).exec(this.client);geodist=(...e)=>new Lt(e,this.opts).exec(this.client);geohash=(...e)=>new Nt(e,this.opts).exec(this.client);geosearch=(...e)=>new Mt(e,this.opts).exec(this.client);geosearchstore=(...e)=>new Ut(e,this.opts).exec(this.client);get=(...e)=>new jt(e,this.opts).exec(this.client);getbit=(...e)=>new Ht(e,this.opts).exec(this.client);getdel=(...e)=>new zt(e,this.opts).exec(this.client);getrange=(...e)=>new Wt(e,this.opts).exec(this.client);getset=(e,t)=>new Kt([e,t],this.opts).exec(this.client);hdel=(...e)=>new Gt(e,this.opts).exec(this.client);hexists=(...e)=>new qt(e,this.opts).exec(this.client);hget=(...e)=>new $t(e,this.opts).exec(this.client);hgetall=(...e)=>new Ft(e,this.opts).exec(this.client);hincrby=(...e)=>new Vt(e,this.opts).exec(this.client);hincrbyfloat=(...e)=>new Jt(e,this.opts).exec(this.client);hkeys=(...e)=>new Xt(e,this.opts).exec(this.client);hlen=(...e)=>new Yt(e,this.opts).exec(this.client);hmget=(...e)=>new Zt(e,this.opts).exec(this.client);hmset=(e,t)=>new Qt([e,t],this.opts).exec(this.client);hrandfield=(e,t,s)=>new pt([e,t,s],this.opts).exec(this.client);hscan=(...e)=>new es(e,this.opts).exec(this.client);hset=(e,t)=>new ts([e,t],this.opts).exec(this.client);hsetnx=(e,t,s)=>new ss([e,t,s],this.opts).exec(this.client);hstrlen=(...e)=>new ns(e,this.opts).exec(this.client);hvals=(...e)=>new is(e,this.opts).exec(this.client);incr=(...e)=>new rs(e,this.opts).exec(this.client);incrby=(...e)=>new os(e,this.opts).exec(this.client);incrbyfloat=(...e)=>new as(e,this.opts).exec(this.client);keys=(...e)=>new Ps(e,this.opts).exec(this.client);lindex=(...e)=>new Is(e,this.opts).exec(this.client);linsert=(e,t,s,n)=>new _s([e,t,s,n],this.opts).exec(this.client);llen=(...e)=>new Ds(e,this.opts).exec(this.client);lmove=(...e)=>new Ls(e,this.opts).exec(this.client);lpop=(...e)=>new Bs(e,this.opts).exec(this.client);lmpop=(...e)=>new Ns(e,this.opts).exec(this.client);lpos=(...e)=>new Ms(e,this.opts).exec(this.client);lpush=(e,...t)=>new Us([e,...t],this.opts).exec(this.client);lpushx=(e,...t)=>new js([e,...t],this.opts).exec(this.client);lrange=(...e)=>new Hs(e,this.opts).exec(this.client);lrem=(e,t,s)=>new zs([e,t,s],this.opts).exec(this.client);lset=(e,t,s)=>new Ws([e,t,s],this.opts).exec(this.client);ltrim=(...e)=>new Ks(e,this.opts).exec(this.client);mget=(...e)=>new Gs(e,this.opts).exec(this.client);mset=e=>new qs([e],this.opts).exec(this.client);msetnx=e=>new $s([e],this.opts).exec(this.client);persist=(...e)=>new Fs(e,this.opts).exec(this.client);pexpire=(...e)=>new Vs(e,this.opts).exec(this.client);pexpireat=(...e)=>new Js(e,this.opts).exec(this.client);pfadd=(...e)=>new Xs(e,this.opts).exec(this.client);pfcount=(...e)=>new Ys(e,this.opts).exec(this.client);pfmerge=(...e)=>new Zs(e,this.opts).exec(this.client);ping=e=>new Qs(e,this.opts).exec(this.client);psetex=(e,t,s)=>new en([e,t,s],this.opts).exec(this.client);pttl=(...e)=>new tn(e,this.opts).exec(this.client);publish=(...e)=>new sn(e,this.opts).exec(this.client);randomkey=()=>new nn().exec(this.client);rename=(...e)=>new rn(e,this.opts).exec(this.client);renamenx=(...e)=>new on(e,this.opts).exec(this.client);rpop=(...e)=>new an(e,this.opts).exec(this.client);rpush=(e,...t)=>new cn([e,...t],this.opts).exec(this.client);rpushx=(e,...t)=>new ln([e,...t],this.opts).exec(this.client);sadd=(e,t,...s)=>new hn([e,t,...s],this.opts).exec(this.client);scan=(...e)=>new un(e,this.opts).exec(this.client);scard=(...e)=>new dn(e,this.opts).exec(this.client);scriptExists=(...e)=>new mn(e,this.opts).exec(this.client);scriptFlush=(...e)=>new pn(e,this.opts).exec(this.client);scriptLoad=(...e)=>new fn(e,this.opts).exec(this.client);sdiff=(...e)=>new wn(e,this.opts).exec(this.client);sdiffstore=(...e)=>new yn(e,this.opts).exec(this.client);set=(e,t,s)=>new xn([e,t,s],this.opts).exec(this.client);setbit=(...e)=>new gn(e,this.opts).exec(this.client);setex=(e,t,s)=>new vn([e,t,s],this.opts).exec(this.client);setnx=(e,t)=>new bn([e,t],this.opts).exec(this.client);setrange=(...e)=>new Rn(e,this.opts).exec(this.client);sinter=(...e)=>new En(e,this.opts).exec(this.client);sinterstore=(...e)=>new Sn(e,this.opts).exec(this.client);sismember=(e,t)=>new On([e,t],this.opts).exec(this.client);smismember=(e,t)=>new Cn([e,t],this.opts).exec(this.client);smembers=(...e)=>new kn(e,this.opts).exec(this.client);smove=(e,t,s)=>new Tn([e,t,s],this.opts).exec(this.client);spop=(...e)=>new An(e,this.opts).exec(this.client);srandmember=(...e)=>new Pn(e,this.opts).exec(this.client);srem=(e,...t)=>new In([e,...t],this.opts).exec(this.client);sscan=(...e)=>new _n(e,this.opts).exec(this.client);strlen=(...e)=>new Dn(e,this.opts).exec(this.client);sunion=(...e)=>new Ln(e,this.opts).exec(this.client);sunionstore=(...e)=>new Nn(e,this.opts).exec(this.client);time=()=>new Bn().exec(this.client);touch=(...e)=>new Mn(e,this.opts).exec(this.client);ttl=(...e)=>new Un(e,this.opts).exec(this.client);type=(...e)=>new jn(e,this.opts).exec(this.client);unlink=(...e)=>new Hn(e,this.opts).exec(this.client);xadd=(...e)=>new Wn(e,this.opts).exec(this.client);xack=(...e)=>new zn(e,this.opts).exec(this.client);xdel=(...e)=>new qn(e,this.opts).exec(this.client);xgroup=(...e)=>new $n(e,this.opts).exec(this.client);xread=(...e)=>new Yn(e,this.opts).exec(this.client);xreadgroup=(...e)=>new Zn(e,this.opts).exec(this.client);xinfo=(...e)=>new Fn(e,this.opts).exec(this.client);xlen=(...e)=>new Vn(e,this.opts).exec(this.client);xpending=(...e)=>new Jn(e,this.opts).exec(this.client);xclaim=(...e)=>new Gn(e,this.opts).exec(this.client);xautoclaim=(...e)=>new Kn(e,this.opts).exec(this.client);xtrim=(...e)=>new ei(e,this.opts).exec(this.client);xrange=(...e)=>new Xn(e,this.opts).exec(this.client);xrevrange=(...e)=>new Qn(e,this.opts).exec(this.client);zadd=(...e)=>"score"in e[1]?new oe([e[0],e[1],...e.slice(2)],this.opts).exec(this.client):new oe([e[0],e[1],...e.slice(2)],this.opts).exec(this.client);zcard=(...e)=>new ti(e,this.opts).exec(this.client);zcount=(...e)=>new si(e,this.opts).exec(this.client);zdiffstore=(...e)=>new gi(e,this.opts).exec(this.client);zincrby=(e,t,s)=>new ni([e,t,s],this.opts).exec(this.client);zinterstore=(...e)=>new ii(e,this.opts).exec(this.client);zlexcount=(...e)=>new ri(e,this.opts).exec(this.client);zmscore=(...e)=>new vi(e,this.opts).exec(this.client);zpopmax=(...e)=>new oi(e,this.opts).exec(this.client);zpopmin=(...e)=>new ai(e,this.opts).exec(this.client);zrange=(...e)=>new ci(e,this.opts).exec(this.client);zrank=(e,t)=>new li([e,t],this.opts).exec(this.client);zrem=(e,...t)=>new hi([e,...t],this.opts).exec(this.client);zremrangebylex=(...e)=>new ui(e,this.opts).exec(this.client);zremrangebyrank=(...e)=>new di(e,this.opts).exec(this.client);zremrangebyscore=(...e)=>new mi(e,this.opts).exec(this.client);zrevrank=(e,t)=>new pi([e,t],this.opts).exec(this.client);zscan=(...e)=>new fi(e,this.opts).exec(this.client);zscore=(e,t)=>new wi([e,t],this.opts).exec(this.client);zunion=(...e)=>new yi(e,this.opts).exec(this.client);zunionstore=(...e)=>new xi(e,this.opts).exec(this.client)},"Redis"),he="v1.34.3";var ue=o(class Si extends le{constructor(t,s){t.url?(t.url.startsWith(" ")||t.url.endsWith(" ")||/\r|\n/.test(t.url))&&console.warn("[Upstash Redis] The redis url contains whitespace or newline, which can cause errors!"):console.warn("[Upstash Redis] The 'url' property is missing or undefined in your Redis config."),t.token?(t.token.startsWith(" ")||t.token.endsWith(" ")||/\r|\n/.test(t.token))&&console.warn("[Upstash Redis] The redis token contains whitespace or newline, which can cause errors!"):console.warn("[Upstash Redis] The 'token' property is missing or undefined in your Redis config.");let n=new ae({retry:t.retry,baseUrl:t.url,headers:{authorization:`Bearer ${t.token}`},responseEncoding:t.responseEncoding,signal:t.signal,keepAlive:t.keepAlive,readYourWrites:t.readYourWrites});if(super(n,{enableTelemetry:!s?.UPSTASH_DISABLE_TELEMETRY,automaticDeserialization:t.automaticDeserialization,latencyLogging:t.latencyLogging,enableAutoPipelining:t.enableAutoPipelining}),this.addTelemetry({platform:"cloudflare",sdk:`@upstash/redis@${he}`}),this.enableAutoPipelining)return this.autoPipeline()}static fromEnv(t,s){let n=t?.UPSTASH_REDIS_REST_URL??UPSTASH_REDIS_REST_URL,i=t?.UPSTASH_REDIS_REST_TOKEN??UPSTASH_REDIS_REST_TOKEN;return n||console.warn("[Upstash Redis] Unable to find environment variable: `UPSTASH_REDIS_REST_URL`. Please add it via `wrangler secret put UPSTASH_REDIS_REST_URL`"),i||console.warn("[Upstash Redis] Unable to find environment variable: `UPSTASH_REDIS_REST_TOKEN`. Please add it via `wrangler secret put UPSTASH_REDIS_REST_TOKEN`"),new Si({...s,url:n,token:i},t)}},"_Redis");async function Oi(e,t){let{credentials:s,...n}=t,i=await fetch(e,n),r=await i.text(),a;try{a=JSON.parse(r)}catch{throw console.error("Failed to parse response as JSON:",r),new Error("Invalid JSON response from server")}if(!i.ok){if(console.error(`HTTP error! status: ${i.status}, body:`,a),a.errorCode==="500.001.1001"&&a.errorMessage==="The transaction is being processed")return{status:"pending",message:"The transaction is being processed",...a};throw new Error(`HTTP error! status: ${i.status}, body: ${JSON.stringify(a)}`)}return a}o(Oi,"fetchWithErrorHandling");async function K(e,t,s){let n=await Oi(`${e}/api/mutation`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:t,args:s,format:"json"})});if(n.status==="error")throw new Error(`Convex mutation error: ${n.errorMessage}`);return n.value}o(K,"convexMutation");function ki(e,t){let s=crypto.getRandomValues(new Uint8Array(t)),n=btoa(String.fromCharCode(...new Uint8Array(s))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");return e?`${e}_${n}`:n}o(ki,"generateApiKey");var Ci=new B;Ci.post("/create",async e=>{let{UPSTASH_REDIS_REST_TOKEN:t,UPSTASH_REDIS_REST_URL:s,CONVEX_URL:n}=e.env,i=new ue({url:s,token:t}),r=await e.req.json(),a=crypto.randomUUID(),c=ki(r.prefix,r.byteLength||16),l={...r,key:c,keyId:a,createdAt:Date.now()},u=encodeURIComponent(c);try{return await i.set(`key:${a}`,JSON.stringify(l)),await i.set(`lookup:${u}`,a),await K(n,"apiRequests:create",{method:"POST",url:"/keys/create",status_code:200,request_body:{...r},result_body:{key:c,keyId:a}}),e.json({key:c,keyId:a})}catch(d){return await K(n,"apiRequests:create",{method:"POST",url:"/keys/create",status_code:500,request_body:{...r},result_body:{error:d instanceof Error?d.message:"Unknown error"}}),console.error("Error in /keys/create:",d),e.json({error:"Internal Server Error"},500)}});var Ti=Ci;var Ai=new B;Ai.post("/verify",async e=>{let{UPSTASH_REDIS_REST_TOKEN:t,UPSTASH_REDIS_REST_URL:s,CONVEX_URL:n}=e.env,i=new ue({url:s,token:t}),r=await e.req.json();try{if(console.log("Parsed request body:",r),!r.key)return e.json({error:"key is required"},400);let a=encodeURIComponent(r.key),c=await i.get(`lookup:${a}`);if(console.log("Key ID:",c),await K(n,"apiRequests:create",{method:"POST",url:"/keys/verify",status_code:200,request_body:{...r},result_body:{valid:!!c}}),c)return e.json({valid:!0});if(!c)return e.json({valid:!1});let l=await i.get(`key:${c}`);if(console.log("Raw key data from Redis:",l),!l||typeof l!="string")return e.json({valid:!1});let u;try{typeof l=="object"?u=l:u=JSON.parse(l)}catch(f){return console.error("Key data parse error:",f),await Promise.all([i.del(`key:${c}`),i.del(`lookup:${a}`)]),e.json({error:"Invalid key data in storage",details:f instanceof Error?f.message:"Unknown parse error",valid:!1},500)}if(u.expires&&u.expires<Date.now())return await Promise.all([i.del(`key:${c}`),i.del(`lookup:${a}`)]),e.json({valid:!1});let d={valid:!0,ownerId:u.ownerId,meta:u.meta,expires:u.expires};return u.ratelimit&&(d.ratelimit={limit:u.ratelimit.limit,remaining:u.ratelimit.limit,reset:Date.now()+u.ratelimit.refillInterval}),e.json(d)}catch(a){return console.error("Error in /keys/verify:",a),await K(n,"apiRequests:create",{method:"POST",url:"/keys/verify",status_code:500,request_body:{...r},result_body:{error:a instanceof Error?a.message:"Unknown error"}}),e.json({error:"Internal Server Error",details:a instanceof Error?a.message:"Unknown error",valid:!1},500)}});var Pi=Ai;var Ue=xe(Vi(),1);typeof atob>"u"&&(global.atob=e=>Buffer.from(e,"base64").toString("utf8"));var Ji=o(class Xi extends le{constructor(t){if("request"in t){super(t);return}t.url?(t.url.startsWith(" ")||t.url.endsWith(" ")||/\r|\n/.test(t.url))&&console.warn("[Upstash Redis] The redis url contains whitespace or newline, which can cause errors!"):console.warn("[Upstash Redis] The 'url' property is missing or undefined in your Redis config."),t.token?(t.token.startsWith(" ")||t.token.endsWith(" ")||/\r|\n/.test(t.token))&&console.warn("[Upstash Redis] The redis token contains whitespace or newline, which can cause errors!"):console.warn("[Upstash Redis] The 'token' property is missing or undefined in your Redis config.");let s=new ae({baseUrl:t.url,retry:t.retry,headers:{authorization:`Bearer ${t.token}`},agent:t.agent,responseEncoding:t.responseEncoding,cache:t.cache??"no-store",signal:t.signal,keepAlive:t.keepAlive,readYourWrites:t.readYourWrites});if(super(s,{automaticDeserialization:t.automaticDeserialization,enableTelemetry:!process.env.UPSTASH_DISABLE_TELEMETRY,latencyLogging:t.latencyLogging,enableAutoPipelining:t.enableAutoPipelining}),this.addTelemetry({runtime:typeof EdgeRuntime=="string"?"edge-light":`node@${process.version}`,platform:process.env.VERCEL?"vercel":process.env.AWS_REGION?"aws":"unknown",sdk:`@upstash/redis@${he}`}),this.enableAutoPipelining)return this.autoPipeline()}static fromEnv(t){if(process.env===void 0)throw new TypeError('[Upstash Redis] Unable to get environment variables, `process.env` is undefined. If you are deploying to cloudflare, please import from "@upstash/redis/cloudflare" instead');let s=process.env.UPSTASH_REDIS_REST_URL||process.env.KV_REST_API_URL;s||console.warn("[Upstash Redis] Unable to find environment variable: `UPSTASH_REDIS_REST_URL`");let n=process.env.UPSTASH_REDIS_REST_TOKEN||process.env.KV_REST_API_TOKEN;return n||console.warn("[Upstash Redis] Unable to find environment variable: `UPSTASH_REDIS_REST_TOKEN`"),new Xi({...t,url:s,token:n})}},"_Redis");async function Yi(e,t){let{UPSTASH_REDIS_REST_TOKEN:s,UPSTASH_REDIS_REST_URL:n}=e.env,i=new Ji({url:n,token:s}),r=new Ue.Ratelimit({redis:i,limiter:Ue.Ratelimit.slidingWindow(5,"30 s")}),a=e.req.header("CF-Connecting-IP")||"127.0.0.1",{success:c,limit:l,remaining:u,reset:d}=await r.limit(a);if(!c)return e.json({error:"Rate limit exceeded"},429);e.header("X-RateLimit-Limit",l.toString()),e.header("X-RateLimit-Remaining",u.toString()),e.header("X-RateLimit-Reset",d.toString()),await t()}o(Yi,"rateLimitMiddleware");var pe=new B().basePath("/keys");pe.use("*",Yi);pe.route("/",Ti);pe.route("/",Pi);var Xu=pe;export{Xu as default};
//# sourceMappingURL=index.js.map
